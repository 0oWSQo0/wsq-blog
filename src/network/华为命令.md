


## 端口镜像
镜像的分类:
* 基于端口的镜像：端口镜像就是将被监控端口上的数据复制到指定的监控端口，对数据进行分析和监视。
* 基于流的镜像：流镜像就是将匹配访问控制列表的业务流复制到指定的监控端口，用于报文的分析和监视。

### 基于端口的镜像


#### 配置本地端口镜像
```shell
[SW] observe-port 1 interface gigabitethernet0/0/3
[SW] interfae gigabitethernet0/0/2
[SW-gigabitethernet0/0/2] port-mirroring to observe-port 1 both
```


## 路由策略
### route-policy
```shell
[Huawei]route-policy name {permit|deny} node node-name
```
默认情况下，所有未匹配的路由将拒绝通过`route-policy`。如果`route-policy`中定义了一个以上的节点，则各节点中至少应该有一个节点的匹配模式为`permit`。

[](华为命令/route-policy.png)

R1的配置：
```shell
# 定义一个 acl2000，用于匹配需要放行的路由
[R1]acl 2000
[R1-acl-basic-2000]rule permit source 172.16.1.0 0.0.0.0
[R1-acl-basic-2000]quit
# 创建-个route-policy,名字叫RP,同时配置第一个节点,节点编号为10
[R1]route-policy RP permit node 10
Info: New Sequence of this List.
[R1-route-policy]if-match ?
  acl                  Specify an ACL
  as-path-filter       BGP AS path list
  community-filter     Match BGP community filter
  cost                 Match metric of route
  extcommunity-filter  Match BGP/VPN extended community filter
  interface            Specify the interface matching the first hop of routes
  ip                   IP information
  ip-prefix            Specify an address prefix-list
  ipv6                 IPv6 Information
  mpls-label           Give the Label
  rd-filter            Route-distinguisher filter
  route-type           Match route-type of route
  tag                  Match tag of route
# 在节点10中，定义了一个if-match子句，调用acl2000
[R1-route-policy]if-match acl 2000
[R1-route-policy]apply ?
  as-path           BGP AS path list
  backup-interface  Backup outgoing interface
  backup-nexthop    Backup nexthop address
  behavior          Specify QoS policy as behavior
  comm-filter       Set BGP community filter (for deletion)
  community         BGP community attribute
  cost              Set metric of route
  cost-type         Type of metric for destination routing protocol
  dampening         Set BGP route flap dampening parameters
  extcommunity      Set BGP/VPN extended community filter
  ip-address        IP information
  ip-precedence     Specify QoS policy as IP precedence
  ipv6              IPv6 Information
  isis              Where to import route
  local-preference  BGP local preference path attribute
  mpls-label        Give the Label
  origin            BGP origin code
  ospf              Where to import route
  preference        Give the Preference  (Route Preference)
  preferred-value   BGP Preferred-value (weight) for routing table
  qos-local-id      Specify QoS policy as qos local id
  tag               Set tag of route
  traffic-index     Specify BGP Traffic Accounting Index

# 在节点10中，定义了一个apply子句，设置cost值为20
[R1-route-policy]apply cost 20
[R1-route-policy]quit
[R1]ospf 1
# 在ospf中注入直连路由的时候调用这个route-policy
[R1-ospf-1]import-route direct route-policy RP

```

## VRRP

[](华为命令/vrrp-default.png)
```shell
[R1]interface GigabitEthernet0/0/0
[R1-GigabitEthernet0/0/0]ip address 192.168.1.253 24
[R1-GigabitEthernet0/0/0]vrrp vrid 1 ?
  authentication-mode  Specify password and authentication mode
  preempt-mode         Specify preempt mode
  priority             Specify priority
  timer                Specify timer
  track                Specify the track configuration
  version-3            Specify the device to support V3 for VRRP
  virtual-ip           Specify virtual IP address
# 激活接口VRRP，加入VRRP组（VRID为1），虚拟IP为192.168.1.254
[R1-GigabitEthernet0/0/0]vrrp vrid 1 virtual-ip 192.168.1.254
# 该接口在该VRRP组中的优先级为120（优先级值默认为100）
[R1-GigabitEthernet0/0/0]vrrp vrid 1 priority 120
[R1-GigabitEthernet0/0/0]vrrp vrid 1 preempt-mode timer ?
  delay  Specify interval of delay
# 配置虚拟路由器的抢占时间为20s
# 抢占时间是指当主设备因为故障修复重新切换为主状态时等待的时间
[R1-GigabitEthernet0/0/0]vrrp vrid 1 preempt-mode timer delay 20
```
```shell
[R2]interface GigabitEthernet 0/0/0
[R2-GigabitEthernet0/0/0]ip address 192.168.1.252 24
[R2-GigabitEthernet0/0/0]vrrp vrid 1 virtual-ip 192.168.1.254
```
查看结果：
```shell
[R1-GigabitEthernet0/0/0]display vrrp ?
  INTEGER<1-255>        Virtual router identifier
  brief                 Summary information
  interface             Specify the interface
  protocol-information  Protocol information of VRRP
  state-change          State change track
  statistics            Statistics about VRRP packets
  |                     Matching output
  <cr>                  Please press ENTER to execute command 
[R1-GigabitEthernet0/0/0]display vrrp
  GigabitEthernet0/0/0 | Virtual Router 1
    State : Master
    Virtual IP : 192.168.1.254
    Master IP : 192.168.1.253
    PriorityRun : 120
    PriorityConfig : 120
    MasterPriority : 120
    Preempt : YES   Delay Time : 20 s
    TimerRun : 1 s
    TimerConfig : 1 s
    Auth type : NONE
    Virtual MAC : 0000-5e00-0101
    Check TTL : YES
    Config type : normal-vrrp
    Backup-forward : disabled
    Create time : 2025-04-17 14:06:16 UTC-08:00
    Last change time : 2025-04-17 14:06:20 UTC-08:00
    
[R1-GigabitEthernet0/0/0]display vrrp brief
Total:1     Master:1     Backup:0     Non-active:0      
VRID  State        Interface                Type     Virtual IP     
----------------------------------------------------------------
1     Master       GE0/0/0                  Normal   192.168.1.254 
```
```shell
[R2-GigabitEthernet0/0/0]display vrrp
  GigabitEthernet0/0/0 | Virtual Router 1
    State : Backup
    Virtual IP : 192.168.1.254
    Master IP : 192.168.1.253
    PriorityRun : 100
    PriorityConfig : 100
    MasterPriority : 120
    Preempt : YES   Delay Time : 0 s
    TimerRun : 1 s
    TimerConfig : 1 s
    Auth type : NONE
    Virtual MAC : 0000-5e00-0101
    Check TTL : YES
    Config type : normal-vrrp
    Backup-forward : disabled
    Create time : 2025-04-17 14:13:58 UTC-08:00
    Last change time : 2025-04-17 14:13:58 UTC-08:00

[R2-GigabitEthernet0/0/0]display vrrp brief 
Total:1     Master:0     Backup:1     Non-active:0      
VRID  State        Interface                Type     Virtual IP     
----------------------------------------------------------------
1     Backup       GE0/0/0                  Normal   192.168.1.254
```
### track接口状态

[](华为命令/vrrp-track.png)

Backup 路由器会不断侦听 Master 发出来的 VRRP 报文以便判断它的存活状态，当 Master 路由器发生故障时，Backup 路由器能够感知并且进行切换。但是如果 Master 路由器没有发生整机故障，而只是其上行接口故障了呢?例如上图中，R1 作为 Master 路由器，如果其 GE0/0/1口 DOWN 掉了，那么用户的上行流量被引导到 R1 后，将会被丢弃。

VRRP 有一个特性可以解决这个问题：通过在 R1 上部署 VRRP track，使其能够跟踪 GE0/0/1的状态，如果 GE0/0/1 的物理状态或者协议状态变为 Down，那么 R1 就会主动将自己的 GE0/0/0 接口 VRRP 优先级减去一个值 从而使得 R2 的优先级值更大、优先级更高，那么 R2 将成为新的 Master R1 则成为 Backup，用户发往默认网关的上行流量便会被引导到 R2。

```shell
[R1]interface GigabitEthernet 0/0/0
[R1-GigabitEthernet0/0/0]ip address 192.168.1.253 24
# 激活接口VRRP，加入VRRP组（VRID为1），虚拟IP为192.168.1.254
[R1-GigabitEthernet0/0/0]vrrp vrid 1 virtual-ip 192.168.1.254
# 该接口在该VRRP组中的优先级为120（优先级值默认为100）
[R1-GigabitEthernet0/0/0]vrrp vrid 1 priority 120
[R1-GigabitEthernet0/0/0]vrrp vrid 1 track ?
  bfd-session  Specify BFD session
  interface    Interface information
  ip           Specify IP protocol
  nqa          Specify NQA test class
[R1-GigabitEthernet0/0/0]vrrp vrid 1 track interface GigabitEthernet 0/0/1 ?
  increased  Increase priority
  reduced    Reduce priority
  <cr>       Please press ENTER to execute command 
[R1-GigabitEthernet0/0/0]vrrp vrid 1 track interface GigabitEthernet 0/0/1 reduced 30
# 配置虚拟路由器的抢占时间为20s
# 抢占时间是指当主设备因为故障修复重新切换为主状态时等待的时间
[R1-GigabitEthernet0/0/0]vrrp vrid 1 preempt-mode timer delay 20
```

## NAT
### NAT在路由器上的配置
#### 基于动态地址池的No-PAT
[](华为命令/nat-static.png)
在上图中，OR 是出口路由器，它连接着内网PC及 Internet。现在内网`192.168.1.0/24`网段的用户需要访问 Internet，该网络从运营商申请到的公网地址区间是`200.1.1.100-200.1.1.116`，完成基于地址池的`No-PAT`配置，使得内网用户能够访问 Internet。
```shell
# 定义NAT池，其标识为1，其中包括的公网地址范围是200.1.1.100-200.1.1.116
[OR]nat address-group 1 200.1.1.100 200.1.1.116
# 定义acl2000，用于匹配允许NAT的内网地址段192.168.1.0/24
[OR]acl 2000
[OR-acl-basic-2000]rule permit source 192.168.1.0 0.0.0.255
[OR-acl-basic-2000]quit
[OR]interface GigabitEthernet 0/0/1
[OR-GigabitEthernet0/0/1]nat outbound ?
  INTEGER<2000-3999>  Apply basic or advanced ACL

[OR-GigabitEthernet0/0/1]nat outbound 2000 address-group 1 ?
  no-pat  Not use PAT
  <cr>    Please press ENTER to execute command 

# 连接在外网的接口上应用基于地址池的No-PAT，将acl2000所匹配的报文与NAT地址池1进行绑定
[OR-GigabitEthernet0/0/1]nat outbound 2000 address-group 1 no-pat
[OR-GigabitEthernet0/0/1]quit
[OR]ip route-static 0.0.0.0 0.0.0.0 200.1.1.2
```

#### NAT Server
[](华为命令/nat-static.png)
在上图中，OR 是出口路由器，它连接着内网 Server 及 Internet。内网有一台 WEB 服务器`192.168.1.100`，其 TCP80 端口需要面向 Internet 提供服务,该网络从运营商申请到的公网地址是`200.1.1.30`，在路由器上完成 NAT Server 的配置，使得 Internet 用户能够通过访问`200.1.1.30:8080`，从而访问`192.168.1.100:80`。
```shell
[OR]interface GigabitEthernet 0/0/1
[OR-GigabitEthernet0/0/1]nat server ?
  global    Specify global information of NAT
  protocol  Specify protocol
[OR-GigabitEthernet0/0/1]nat server protocol ?
  <1-255>  Protocol number
  icmp     Internet Control Message Protocol (1)
  tcp      Transmission Control Protocol (6)
  udp      User Datagram Protocol (17)
[OR-GigabitEthernet0/0/1]nat server protocol tcp global 200.1.1.30 8080 inside 192.168.1.100 80
[OR]ip route-static 0.0.0.0 0.0.0.0 200.1.1.2
```
