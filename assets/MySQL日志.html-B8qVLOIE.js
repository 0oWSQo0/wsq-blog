import{_ as a}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as l,d as n,o}from"./app-BAoNGAQX.js";const e={};function p(c,s){return o(),l("div",null,s[0]||(s[0]=[n(`<h2 id="日志及分类" tabindex="-1"><a class="header-anchor" href="#日志及分类"><span>日志及分类</span></a></h2><p>日志是数据库的重要组成部分，主要用来记录数据库的运行情况、日常操作和错误信息。</p><p>MySQL 中的日志可以分为二进制日志、错误日志、通用查询日志和慢查询日志。分析这些日志，可以帮助我们了解 MySQL 数据库的运行情况、日常操作、错误信息和哪些地方需要进行优化。</p><p>MySQL 中 4 种日志文件的作用：</p><ul><li>二进制日志：该日志文件会以二进制的形式记录数据库的各种操作，但不记录查询语句。</li><li>错误日志：该日志文件会记录 MySQL 服务器的启动、关闭和运行错误等信息。</li><li>通用查询日志：该日志记录 MySQL 服务器的启动和关闭信息、客户端的连接信息、更新、查询数据记录的 SQL 语句等。</li><li>慢查询日志：记录执行事件超过指定时间的操作，通过工具分析慢查询日志可以定位 MySQL 服务器性能瓶颈所在。</li></ul><p>为了维护 MySQL 数据库，经常需要在 MySQL 中进行日志操作，包含日志文件的启动、查看、停止和删除等，这些操作都是数据库管理中最基本、最重要的操作。</p><p>例如，当用户<code>root</code>登录到 MySQL 服务器后，就会在日志文件里记录该用户的登录事件、执行操作等信息。当 MySQL 服务器运行时出错，出错信息就会被记录到日志文件里。</p><p>日志操作是数据库维护中最重要的手段之一。如果 MySQL 数据库系统意外停止服务，我们可以通过错误日志查看出现错误的原因。还可以通过二进制日志文件来查看用户分别执行了哪些操作、对数据库文件做了哪些修改。然后，还可以根据二进制日志中的记录来修复数据库。</p><p>在 MySQL 所支持的日志文件里，除了二进制日志文件外，其它日志文件都是文本文件。默认情况下，MySQL 只会启动错误日志文件，而其它日志则需要手动启动。</p><p>使用日志有优点也有缺点。启动日志后，虽然可以对 MySQL 服务器性能进行维护，但是会降低 MySQL 的执行速度。例如，一个查询操作比较频繁的 MySQL 中，记录通用查询日志和慢查询日志要花费很多的时间。</p><p>日志文件还会占用大量的硬盘空间。对于用户量非常大、操作非常频繁的数据库，日志文件需要的存储空间甚至比数据库文件需要的存储空间还要大。因此，是否启动日志，启动什么类型的日志要根据具体的应用来决定。</p><h2 id="错误日志" tabindex="-1"><a class="header-anchor" href="#错误日志"><span>错误日志</span></a></h2><p>错误日志主要记录 MySQL 服务器启动和停止过程中的信息、服务器在运行过程中发生的故障和异常情况等。</p><h3 id="启动和设置错误日志" tabindex="-1"><a class="header-anchor" href="#启动和设置错误日志"><span>启动和设置错误日志</span></a></h3><p>在 MySQL 数据库中，默认开启错误日志功能。一般情况下，错误日志存储在 MySQL 数据库的数据文件夹下，通常名称为<code>hostname.err</code>。其中，<code>hostname</code>表示 MySQL 服务器的主机名。</p><p>在 MySQL 配置文件中，错误日志所记录的信息可以通过<code>log-error</code>和<code>log-warnings</code>来定义，其中，<code>log-err</code>定义是否启用错误日志功能和错误日志的存储位置，<code>log-warnings</code>定义是否将警告信息也记录到错误日志中。</p><p>将<code>log_error</code>选项加入到 MySQL 配置文件的 <code>[mysqld]</code>组中：</p><div class="language-" data-highlighter="shiki" data-ext="" data-title="" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span>[mysqld]</span></span>
<span class="line"><span>log-error=dir/{filename}</span></span></code></pre></div><p>其中，<code>dir</code>参数指定错误日志的存储路径；<code>filename</code>参数指定错误日志的文件名；省略参数时文件名默认为主机名，存放在<code>Data</code>目录中。</p><p>重启 MySQL 服务后，参数开始生效，可以在指定路径下看到<code>filename.err</code>的文件，如果没有指定<code>filename</code>，那么错误日志将直接默认为<code>hostname.err</code>。</p><p>注意：错误日志中记录的并非全是错误信息，例如 MySQL 如何启动 InnoDB 的表空间文件、如何初始化自己的存储引擎等，这些也记录在错误日志文件中。</p><h3 id="查看错误日志" tabindex="-1"><a class="header-anchor" href="#查看错误日志"><span>查看错误日志</span></a></h3><p>在 MySQL 中，通过<code>SHOW</code>命令可以查看错误日志文件所在的目录及文件名信息。</p><div class="language-sql" data-highlighter="shiki" data-ext="sql" data-title="sql" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span style="color:#F0F3F6;">mysql</span><span style="color:#FF9492;">&gt;</span><span style="color:#F0F3F6;"> SHOW VARIABLES </span><span style="color:#FF9492;">LIKE</span><span style="color:#ADDCFF;"> &#39;log_error&#39;</span><span style="color:#F0F3F6;">;</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">---------------+----------------------------------------------------------------+</span></span>
<span class="line"><span style="color:#F0F3F6;">| Variable_name | </span><span style="color:#FF9492;">Value</span><span style="color:#F0F3F6;">                                                          |</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">---------------+----------------------------------------------------------------+</span></span>
<span class="line"><span style="color:#F0F3F6;">| log_error     | C:\\ProgramData\\MySQL\\MySQL </span><span style="color:#FF9492;">Server</span><span style="color:#91CBFF;"> 5</span><span style="color:#F0F3F6;">.</span><span style="color:#91CBFF;">7</span><span style="color:#F0F3F6;">\\</span><span style="color:#FF9492;">Data</span><span style="color:#F0F3F6;">\\LAPTOP</span><span style="color:#FF9492;">-</span><span style="color:#91CBFF;">UHQ6V8KP</span><span style="color:#F0F3F6;">.</span><span style="color:#91CBFF;">err</span><span style="color:#F0F3F6;"> |</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">---------------+----------------------------------------------------------------+</span></span></code></pre></div><p>错误日志以文本文件的形式存储，直接使用普通文本工具就可以查看。</p><h3 id="删除错误日志" tabindex="-1"><a class="header-anchor" href="#删除错误日志"><span>删除错误日志</span></a></h3><p>在 MySQL 中，可以使用<code>mysqladmin</code>命令来开启新的错误日志。</p><div class="language-sql" data-highlighter="shiki" data-ext="sql" data-title="sql" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span style="color:#F0F3F6;">mysqladmin </span><span style="color:#FF9492;">-</span><span style="color:#F0F3F6;">uroot </span><span style="color:#FF9492;">-</span><span style="color:#F0F3F6;">p flush</span><span style="color:#FF9492;">-</span><span style="color:#F0F3F6;">logs</span></span></code></pre></div><p>执行该命令后，MySQL 服务器首先会自动创建一个新的错误日志，然后将旧的错误日志更名为<code>filename.err-old</code>。</p><p>MySQL 服务器发生异常时，可以在错误日志中找到发生异常的时间、原因，然后根据这些信息来解决异常。对于很久之前的错误日志，查看的可能性不大，可以直接将这些错误日志删除。</p><h2 id="二进制日志" tabindex="-1"><a class="header-anchor" href="#二进制日志"><span>二进制日志</span></a></h2><p>二进制日志也可叫作变更日志。主要用于记录数据库的变化情况，即 SQL 语句的 DDL 和 DML 语句，不包含数据记录查询操作。</p><p>如果 MySQL 数据库意外停止，可以通过二进制日志文件来查看用户执行了哪些操作，对数据库服务器文件做了哪些修改，然后根据二进制日志文件中的记录来恢复数据库服务器。</p><p>默认情况下，二进制日志功能是关闭的。可以通过以下命令查看二进制日志是否开启：</p><div class="language-sql" data-highlighter="shiki" data-ext="sql" data-title="sql" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span style="color:#F0F3F6;">mysql</span><span style="color:#FF9492;">&gt;</span><span style="color:#F0F3F6;"> SHOW VARIABLES </span><span style="color:#FF9492;">LIKE</span><span style="color:#ADDCFF;"> &#39;log_bin&#39;</span><span style="color:#F0F3F6;">;</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">---------------+-------+</span></span>
<span class="line"><span style="color:#F0F3F6;">| Variable_name | </span><span style="color:#FF9492;">Value</span><span style="color:#F0F3F6;"> |</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">---------------+-------+</span></span>
<span class="line"><span style="color:#F0F3F6;">| log_bin       | </span><span style="color:#FF9492;">OFF</span><span style="color:#F0F3F6;">   |</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">---------------+-------+</span></span></code></pre></div><h3 id="启动和设置二进制日志" tabindex="-1"><a class="header-anchor" href="#启动和设置二进制日志"><span>启动和设置二进制日志</span></a></h3><p>在 MySQL 中，可以通过在配置文件中添加<code>log-bin</code>选项来开启二进制日志：</p><div class="language-" data-highlighter="shiki" data-ext="" data-title="" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span>[mysqld]</span></span>
<span class="line"><span>log-bin=dir/[filename]</span></span></code></pre></div><p>其中，<code>dir</code>参数指定二进制文件的存储路径；<code>filename</code>参数指定二进制文件的文件名，其形式为<code>filename.number</code>，<code>number</code>的形式为 000001、000002 等。</p><p>每次重启 MySQL 服务后，都会生成一个新的二进制日志文件，这些日志文件的文件名中<code>filename</code>部分不会改变，<code>number</code>会不断递增。</p><p>如果没有<code>dir</code>和<code>filename</code>参数，二进制日志将默认存储在数据库的数据目录下，默认的文件名为<code>hostname-bin.number</code>，其中<code>hostname</code>表示主机名。</p><p>下面在<code>my.ini</code>文件的<code>[mysqld]</code>组中添加以下语句：</p><div class="language-" data-highlighter="shiki" data-ext="" data-title="" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span>log-bin</span></span></code></pre></div><p>重启 MySQL 服务器后，可以在 MySQL 数据库的数据目录下看到<code>LAPTOP-UHQ6V8KP-bin.000001</code>这个文件，同时还生成了<code>LAPTOP-UHQ6V8KP-bin.index</code>文件。此处，MySQL 服务器的主机名为<code>LAPTOP-UHQ6V8KP</code>。</p><p>还可以在<code>my.ini</code>文件的<code>[mysqld]</code>组中进行如下修改。</p><div class="language-" data-highlighter="shiki" data-ext="" data-title="" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span>log-bin=C:log\\mylog</span></span></code></pre></div><p>重启 MySQL 服务后，可以在<code>C:log</code>文件夹下看到<code>mylog.000001</code>文件和<code>mylog.index</code>文件。</p><h3 id="查看二进制日志" tabindex="-1"><a class="header-anchor" href="#查看二进制日志"><span>查看二进制日志</span></a></h3><h4 id="_1-查看二进制日志文件列表" tabindex="-1"><a class="header-anchor" href="#_1-查看二进制日志文件列表"><span>1. 查看二进制日志文件列表</span></a></h4><p>可以使用如下命令查看 MySQL 中有哪些二进制日志文件：</p><div class="language-sql" data-highlighter="shiki" data-ext="sql" data-title="sql" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span style="color:#F0F3F6;">mysql</span><span style="color:#FF9492;">&gt;</span><span style="color:#F0F3F6;"> SHOW </span><span style="color:#FF9492;">binary</span><span style="color:#F0F3F6;"> logs;</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">----------------------------+-----------+</span></span>
<span class="line"><span style="color:#F0F3F6;">| Log_name                   | File_size |</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">----------------------------+-----------+</span></span>
<span class="line"><span style="color:#F0F3F6;">| LAPTOP</span><span style="color:#FF9492;">-</span><span style="color:#F0F3F6;">UHQ6V8KP</span><span style="color:#FF9492;">-</span><span style="color:#91CBFF;">bin</span><span style="color:#F0F3F6;">.</span><span style="color:#91CBFF;">000001</span><span style="color:#F0F3F6;"> |       </span><span style="color:#91CBFF;">177</span><span style="color:#F0F3F6;"> |</span></span>
<span class="line"><span style="color:#F0F3F6;">| LAPTOP</span><span style="color:#FF9492;">-</span><span style="color:#F0F3F6;">UHQ6V8KP</span><span style="color:#FF9492;">-</span><span style="color:#91CBFF;">bin</span><span style="color:#F0F3F6;">.</span><span style="color:#91CBFF;">000002</span><span style="color:#F0F3F6;"> |       </span><span style="color:#91CBFF;">154</span><span style="color:#F0F3F6;"> |</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">----------------------------+-----------+</span></span></code></pre></div><h4 id="_2-查看当前正在写入的二进制日志文件" tabindex="-1"><a class="header-anchor" href="#_2-查看当前正在写入的二进制日志文件"><span>2. 查看当前正在写入的二进制日志文件</span></a></h4><p>可以使用以下命令查看当前 MySQL 中正在写入的二进制日志文件。</p><div class="language-sql" data-highlighter="shiki" data-ext="sql" data-title="sql" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span style="color:#F0F3F6;">mysql</span><span style="color:#FF9492;">&gt;</span><span style="color:#F0F3F6;"> SHOW </span><span style="color:#FF9492;">master</span><span style="color:#FF9492;"> status</span><span style="color:#F0F3F6;">;</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">----------------------------+----------+--------------+------------------+-------------------+</span></span>
<span class="line"><span style="color:#F0F3F6;">| </span><span style="color:#FF9492;">File</span><span style="color:#F0F3F6;">                       | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">----------------------------+----------+--------------+------------------+-------------------+</span></span>
<span class="line"><span style="color:#F0F3F6;">| LAPTOP</span><span style="color:#FF9492;">-</span><span style="color:#F0F3F6;">UHQ6V8KP</span><span style="color:#FF9492;">-</span><span style="color:#91CBFF;">bin</span><span style="color:#F0F3F6;">.</span><span style="color:#91CBFF;">000002</span><span style="color:#F0F3F6;"> |      </span><span style="color:#91CBFF;">154</span><span style="color:#F0F3F6;"> |              |                  |                   |</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">----------------------------+----------+--------------+------------------+-------------------+</span></span></code></pre></div><h4 id="_3-查看二进制日志文件内容" tabindex="-1"><a class="header-anchor" href="#_3-查看二进制日志文件内容"><span>3. 查看二进制日志文件内容</span></a></h4><p>二进制日志使用二进制格式存储，不能直接打开查看。如果需要查看二进制日志，必须使用<code>mysqlbinlog</code>命令。</p><div class="language-" data-highlighter="shiki" data-ext="" data-title="" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span>mysqlbinlog filename.number</span></span></code></pre></div><p><code>mysqlbinlog</code>命令只在当前文件夹下查找指定的二进制日志，因此需要在二进制日志所在的目录下运行该命令，否则将会找不到指定的二进制日志文件。</p><p>下面使用<code>mysqlbinlog</code>命令，来查看<code>C:\\log</code>目录下的<code>mylog.000001</code>文件：</p><div class="language-" data-highlighter="shiki" data-ext="" data-title="" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span>C:\\Users\\11645&gt;cd C:\\log</span></span>
<span class="line"><span>C:\\log&gt;mysqlbinlog mylog.000001</span></span>
<span class="line"><span>/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=1*/;</span></span>
<span class="line"><span>/*!50003 SET @OLD_COMPLETION_TYPE=@@COMPLETION_TYPE,COMPLETION_TYPE=0*/;</span></span>
<span class="line"><span>DELIMITER /*!*/;</span></span>
<span class="line"><span># at 4</span></span>
<span class="line"><span>#200527  9:33:37 server id 1  end_log_pos 123 CRC32 0x69738cfd  Start: binlog v 4, server v 5.7.29-log created 200527  9:33:37 at startup</span></span>
<span class="line"><span>......</span></span></code></pre></div><p>使用<code>mysqlbinlog</code>命令时，可以指定二进制文件的存储路径。这样可以确保<code>mysqlbinlog</code>命令可以找到二进制文件。上面例子中的命令可以变为如下形式：</p><div class="language-" data-highlighter="shiki" data-ext="" data-title="" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span>mysqlbinlog C:\\log\\mylog.000001</span></span></code></pre></div><p>这样，<code>mysqlbinlog</code>命令就会到<code>C:\\log</code>目录下去查找<code>mylog.000001</code>文件。如果不指定路径，<code>mysqlbinlog</code>命令将在当前目录下查找<code>mylog.000001</code>文件。</p><p>除了<code>filename.number</code>文件，MySQL 还会生成一个名为<code>filename.index</code>的文件，这个文件存储着所有二进制日志文件的列表，可以用记事本打开该文件。</p><p>小技巧：实际工作中，二进制日志文件与数据库的数据文件不放在同一块硬盘上，这样即使数据文件所在的硬盘被破坏，也可以使用另一块硬盘上的二进制日志来恢复数据库文件。两块硬盘同时坏了的可能性要小得多，这样可以保证数据库中数据的安全。</p><h3 id="删除二进制日志" tabindex="-1"><a class="header-anchor" href="#删除二进制日志"><span>删除二进制日志</span></a></h3><p>二进制日志中记录着大量的信息，如果很长时间不清理二进制日志，将会浪费很多的磁盘空间。</p><h4 id="_1-删除所有二进制日志" tabindex="-1"><a class="header-anchor" href="#_1-删除所有二进制日志"><span>1. 删除所有二进制日志</span></a></h4><p>使用<code>RESET MASTER</code>语句可以删除的所有二进制日志：</p><div class="language-" data-highlighter="shiki" data-ext="" data-title="" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span>RESET MASTER;</span></span></code></pre></div><p>登录 MySQL 数据库后，可以执行该语句来删除所有二进制日志。删除所有二进制日志后，MySQL 将会重新创建新的二进制日志，新二进制日志的编号从 000001 开始。</p><h4 id="_2-根据编号删除二进制日志" tabindex="-1"><a class="header-anchor" href="#_2-根据编号删除二进制日志"><span>2. 根据编号删除二进制日志</span></a></h4><p>每个二进制日志文件后面有一个 6 位数的编号，如 000001。使用<code>PURGE MASTER LOGS TO</code>语句，可以删除指定二进制日志的编号之前的日志。</p><div class="language-sql" data-highlighter="shiki" data-ext="sql" data-title="sql" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span style="color:#F0F3F6;">PURGE </span><span style="color:#FF9492;">MASTER</span><span style="color:#F0F3F6;"> LOGS </span><span style="color:#FF9492;">TO</span><span style="color:#ADDCFF;"> &#39;filename.number&#39;</span><span style="color:#F0F3F6;">;</span></span></code></pre></div><p>该语句将删除编号小于<code>filename.number</code>的所有二进制日志。</p><h4 id="_3-根据创建时间删除二进制日志" tabindex="-1"><a class="header-anchor" href="#_3-根据创建时间删除二进制日志"><span>3. 根据创建时间删除二进制日志</span></a></h4><p>使用<code>PURGE MASTER LOGS TO</code>语句，可以删除指定时间之前创建的二进制日志：</p><div class="language-sql" data-highlighter="shiki" data-ext="sql" data-title="sql" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span style="color:#F0F3F6;">PURGE </span><span style="color:#FF9492;">MASTER</span><span style="color:#F0F3F6;"> LOGS </span><span style="color:#FF9492;">TO</span><span style="color:#ADDCFF;"> &#39;yyyy-mm-dd hh:MM:ss&#39;</span><span style="color:#F0F3F6;">;</span></span></code></pre></div><h3 id="暂时停止二进制日志" tabindex="-1"><a class="header-anchor" href="#暂时停止二进制日志"><span>暂时停止二进制日志</span></a></h3><p>在配置文件中设置了<code>log_bin</code>选项之后，MySQL 服务器将会一直开启二进制日志功能。删除该选项后就可以停止二进制日志功能，如果需要再次启动这个功能，需要重新添加<code>log_bin</code>选项。由于这样比较麻烦，所以 MySQL 提供了暂时停止二进制日志功能的语句。</p><p>如果用户不希望自己执行的某些 SQL 语句记录在二进制日志中，可以在执行这些 SQL 语句之前暂停二进制日志功能。</p><p>使用<code>SET</code>语句来暂停/开启二进制日志功能：</p><div class="language-sql" data-highlighter="shiki" data-ext="sql" data-title="sql" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span style="color:#FF9492;">SET</span><span style="color:#F0F3F6;"> SQL_LOG_BIN</span><span style="color:#FF9492;">=</span><span style="color:#91CBFF;">0</span><span style="color:#FF9492;">/</span><span style="color:#91CBFF;">1</span><span style="color:#F0F3F6;">;</span></span></code></pre></div><p>0 表示暂停二进制日志功能，1 表示开启二进制功能。</p><p><code>my.ini</code>中的<code>[mysqld]</code>组下面有几个设置参数是关于二进制日志的：</p><div class="language-" data-highlighter="shiki" data-ext="" data-title="" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span>expire_logs_days = 10</span></span>
<span class="line"><span>max_binlog_size = 1​00M</span></span></code></pre></div><p><code>expire_logs_day</code>定义了 MySQL 清除过期日志的时间、二进制日志自动删除的天数。默认值为 0，表示“没有自动删除”。当 MySQL 启动或刷新二进制日志时可能删除。</p><p><code>max_binlog_size</code>定义了单个文件的大小限制，如果二进制日志写入的内容大小超出给定值，日志就会发生滚动（关闭当前文件，重新打开一个新的日志文件）。不能将该变量设置为大于 1GB 或小于 4096B（字节），其默认值是 1GB。</p><h2 id="使用二进制日志还原数据库" tabindex="-1"><a class="header-anchor" href="#使用二进制日志还原数据库"><span>使用二进制日志还原数据库</span></a></h2><p>二进制日志中记录了用户对数据库更改的所有操作，如<code>INSERT</code>语句、<code>UPDATE</code>语句、<code>CREATE</code>语句等。如果数据库因为操作不当或其它原因丢失了数据，可以通过二进制日志来查看在一定时间段内用户的操作，结合数据库备份来还原数据库。</p><p>数据库遭到意外损坏时，应该先使用最近的备份文件来还原数据库。另外备份之后，数据库可能进行了一些更新，这时可以使用二进制日志来还原。因为二进制日志中存储了更新数据库的语句，如<code>UPDATE</code>语句、<code>INSERT</code>语句等。</p><p>二进制日志还原数据库的命令如下：</p><div class="language-sql" data-highlighter="shiki" data-ext="sql" data-title="sql" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span style="color:#F0F3F6;">mysqlbinlog </span><span style="color:#91CBFF;">filename</span><span style="color:#F0F3F6;">.</span><span style="color:#91CBFF;">number</span><span style="color:#F0F3F6;"> | mysql </span><span style="color:#FF9492;">-</span><span style="color:#F0F3F6;">u </span><span style="color:#FF9492;">root</span><span style="color:#FF9492;"> -</span><span style="color:#F0F3F6;">p</span></span></code></pre></div><p>以上命令可以理解成，先使用<code>mysqlbinlog</code>命令来读取<code>filename.number</code>中的内容，再使用<code>mysql</code>命令将这些内容还原到数据库中。</p><p>技巧：二进制日志虽然可以用来还原 MySQL 数据库，但是其占用的磁盘空间也是非常大的。因此，在备份 MySQL 数据库之后，应该删除备份之前的二进制日志。如果备份之后发生异常，造成数据库的数据损失，可以通过备份之后的二进制日志进行还原。</p><p>使用<code>mysqlbinlog</code>命令进行还原操作时，必须是编号小的先还原。例如，<code>mylog.000001</code>必须在<code>mylog.000002</code>之前还原。</p><p>下面使用二进制日志来还原数据库：</p><div class="language-sql" data-highlighter="shiki" data-ext="sql" data-title="sql" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span style="color:#F0F3F6;">mysqlbinlog </span><span style="color:#91CBFF;">mylog</span><span style="color:#F0F3F6;">.</span><span style="color:#91CBFF;">000001</span><span style="color:#F0F3F6;"> | mysql </span><span style="color:#FF9492;">-</span><span style="color:#F0F3F6;">u </span><span style="color:#FF9492;">root</span><span style="color:#FF9492;"> -</span><span style="color:#F0F3F6;">p</span></span>
<span class="line"><span style="color:#F0F3F6;">mysqlbinlog </span><span style="color:#91CBFF;">mylog</span><span style="color:#F0F3F6;">.</span><span style="color:#91CBFF;">000002</span><span style="color:#F0F3F6;"> | mysql </span><span style="color:#FF9492;">-</span><span style="color:#F0F3F6;">u </span><span style="color:#FF9492;">root</span><span style="color:#FF9492;"> -</span><span style="color:#F0F3F6;">p</span></span>
<span class="line"><span style="color:#F0F3F6;">mysqlbinlog </span><span style="color:#91CBFF;">mylog</span><span style="color:#F0F3F6;">.</span><span style="color:#91CBFF;">000003</span><span style="color:#F0F3F6;"> | mysql </span><span style="color:#FF9492;">-</span><span style="color:#F0F3F6;">u </span><span style="color:#FF9492;">root</span><span style="color:#FF9492;"> -</span><span style="color:#F0F3F6;">p</span></span>
<span class="line"><span style="color:#F0F3F6;">mysqlbinlog </span><span style="color:#91CBFF;">mylog</span><span style="color:#F0F3F6;">.</span><span style="color:#91CBFF;">000004</span><span style="color:#F0F3F6;"> | mysql </span><span style="color:#FF9492;">-</span><span style="color:#F0F3F6;">u </span><span style="color:#FF9492;">root</span><span style="color:#FF9492;"> -</span><span style="color:#F0F3F6;">p</span></span></code></pre></div><h2 id="通用查询日志" tabindex="-1"><a class="header-anchor" href="#通用查询日志"><span>通用查询日志</span></a></h2><p>通用查询日志用来记录用户的所有操作，包括启动和关闭 MySQL 服务、更新语句和查询语句等。</p><p>默认情况下，通用查询日志功能是关闭的。可以通过以下命令查看通用查询日志是否开启：</p><div class="language-sql" data-highlighter="shiki" data-ext="sql" data-title="sql" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span style="color:#F0F3F6;">mysql</span><span style="color:#FF9492;">&gt;</span><span style="color:#F0F3F6;"> SHOW VARIABLES </span><span style="color:#FF9492;">LIKE</span><span style="color:#ADDCFF;"> &#39;%general%&#39;</span><span style="color:#F0F3F6;">;</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">------------------+----------------------------------------------------------------+</span></span>
<span class="line"><span style="color:#F0F3F6;">| Variable_name    | </span><span style="color:#FF9492;">Value</span><span style="color:#F0F3F6;">                                                          |</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">------------------+----------------------------------------------------------------+</span></span>
<span class="line"><span style="color:#F0F3F6;">| general_log      | </span><span style="color:#FF9492;">OFF</span><span style="color:#F0F3F6;">                                                            |</span></span>
<span class="line"><span style="color:#F0F3F6;">| general_log_file | C:\\ProgramData\\MySQL\\MySQL </span><span style="color:#FF9492;">Server</span><span style="color:#91CBFF;"> 5</span><span style="color:#F0F3F6;">.</span><span style="color:#91CBFF;">7</span><span style="color:#F0F3F6;">\\</span><span style="color:#FF9492;">Data</span><span style="color:#F0F3F6;">\\LAPTOP</span><span style="color:#FF9492;">-</span><span style="color:#91CBFF;">UHQ6V8KP</span><span style="color:#F0F3F6;">.</span><span style="color:#91CBFF;">log</span><span style="color:#F0F3F6;"> |</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">------------------+----------------------------------------------------------------+</span></span></code></pre></div><p>从结果可以看出，通用查询日志是关闭的，<code>general_log_file</code>变量指定了通用查询日志文件所在的位置。</p><h3 id="启动和设置通用查询日志" tabindex="-1"><a class="header-anchor" href="#启动和设置通用查询日志"><span>启动和设置通用查询日志</span></a></h3><p>在 MySQL 中，可以通过在 MySQL 配置文件添加<code>log</code>选项来开启通用查询日志：</p><div class="language-" data-highlighter="shiki" data-ext="" data-title="" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span>[mysqld]</span></span>
<span class="line"><span>log=dir/filename</span></span></code></pre></div><p>其中，<code>dir</code>参数指定通用查询日志的存储路径；<code>filename</code>参数指定日志的文件名。如果不指定存储路径，通用查询日志将默认存储到 MySQL 数据库的数据文件夹下。如果不指定文件名，默认文件名为<code>hostname.log</code>，其中<code>hostname</code>表示主机名。</p><h3 id="查看通用查询日志" tabindex="-1"><a class="header-anchor" href="#查看通用查询日志"><span>查看通用查询日志</span></a></h3><p>如果希望了解用户最近的操作，可以查看通用查询日志。通用查询日志以文本文件的形式存储，可以使用普通文本文件查看该类型日志内容。</p><p>首先我们查看通用查询日志功能是否是开启状态，然后查询<code>tb_student</code>表的记录：</p><div class="language-sql" data-highlighter="shiki" data-ext="sql" data-title="sql" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span style="color:#F0F3F6;">mysql</span><span style="color:#FF9492;">&gt;</span><span style="color:#F0F3F6;"> SHOW VARIABLES </span><span style="color:#FF9492;">LIKE</span><span style="color:#ADDCFF;"> &#39;%general%&#39;</span><span style="color:#F0F3F6;">;</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">------------------+----------------------------------------------------------------+</span></span>
<span class="line"><span style="color:#F0F3F6;">| Variable_name    | </span><span style="color:#FF9492;">Value</span><span style="color:#F0F3F6;">                                                          |</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">------------------+----------------------------------------------------------------+</span></span>
<span class="line"><span style="color:#F0F3F6;">| general_log      | </span><span style="color:#FF9492;">ON</span><span style="color:#F0F3F6;">                                                             |</span></span>
<span class="line"><span style="color:#F0F3F6;">| general_log_file | C:\\ProgramData\\MySQL\\MySQL </span><span style="color:#FF9492;">Server</span><span style="color:#91CBFF;"> 5</span><span style="color:#F0F3F6;">.</span><span style="color:#91CBFF;">7</span><span style="color:#F0F3F6;">\\</span><span style="color:#FF9492;">Data</span><span style="color:#F0F3F6;">\\LAPTOP</span><span style="color:#FF9492;">-</span><span style="color:#91CBFF;">UHQ6V8KP</span><span style="color:#F0F3F6;">.</span><span style="color:#91CBFF;">log</span><span style="color:#F0F3F6;"> |</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">------------------+----------------------------------------------------------------+</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F0F3F6;">mysql</span><span style="color:#FF9492;">&gt;</span><span style="color:#FF9492;"> use</span><span style="color:#F0F3F6;"> test;</span></span>
<span class="line"><span style="color:#FF9492;">Database</span><span style="color:#F0F3F6;"> changed</span></span>
<span class="line"><span style="color:#F0F3F6;">mysql</span><span style="color:#FF9492;">&gt;</span><span style="color:#FF9492;"> SELECT</span><span style="color:#FF9492;"> *</span><span style="color:#FF9492;"> FROM</span><span style="color:#F0F3F6;"> tb_student;</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">----+--------+</span></span>
<span class="line"><span style="color:#F0F3F6;">| id | </span><span style="color:#FF9492;">name</span><span style="color:#F0F3F6;">   |</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">----+--------+</span></span>
<span class="line"><span style="color:#F0F3F6;">|  </span><span style="color:#91CBFF;">1</span><span style="color:#F0F3F6;"> | Java   |</span></span>
<span class="line"><span style="color:#F0F3F6;">|  </span><span style="color:#91CBFF;">2</span><span style="color:#F0F3F6;"> | MySQL  |</span></span>
<span class="line"><span style="color:#F0F3F6;">|  </span><span style="color:#91CBFF;">3</span><span style="color:#F0F3F6;"> | Python |</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">----+--------+</span></span></code></pre></div><p>执行成功后，打开通用查询日志，这里日志名称为<code>LAPTOP-UHQ6V8KP.log</code>，下面是通用查询日志中的部分内容。</p><div class="language-" data-highlighter="shiki" data-ext="" data-title="" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span>C:\\Program Files\\MySQL\\MySQL Server 5.7\\bin\\mysqld.exe, Version: 5.7.29-log (MySQL Community Server (GPL)). started with:</span></span>
<span class="line"><span>TCP Port: 3306, Named Pipe: MySQL</span></span>
<span class="line"><span>Time                 Id Command    Argument</span></span>
<span class="line"><span>2020-05-29T06:43:44.382878Z     7 Quit</span></span>
<span class="line"><span>2020-05-29T06:44:10.001382Z     8 Connect root@localhost on  using SSL/TLS</span></span>
<span class="line"><span>2020-05-29T06:44:10.007532Z     8 Query select @@version_comment limit 1</span></span>
<span class="line"><span>2020-05-29T06:44:11.748179Z     8 Query SHOW VARIABLES LIKE &#39;%general%&#39;</span></span>
<span class="line"><span>2020-05-29T06:44:25.487472Z     8 Query SELECT DATABASE()</span></span>
<span class="line"><span>2020-05-29T06:44:25.487748Z     8 Init DB test</span></span>
<span class="line"><span>2020-05-29T06:44:35.390523Z     8 Query SELECT * FROM tb_student</span></span></code></pre></div><p>可以看出，该日志非常清晰地记录了客户端的所有行为。</p><h3 id="停止通用查询日志" tabindex="-1"><a class="header-anchor" href="#停止通用查询日志"><span>停止通用查询日志</span></a></h3><p>通用查询日志启动后，可以通过两种方法停止该日志。一种是将 MySQL 配置文件中的相关配置注释掉，然后重启服务器，来停止通用查询日志。</p><div class="language-" data-highlighter="shiki" data-ext="" data-title="" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span>[mysqld]</span></span>
<span class="line"><span>#log=dir\\filename</span></span></code></pre></div><p>上述方法需要重启 MySQL 服务器，这在某些场景，比如有业务量访问的情况下是不允许的，这时可以通过另一种方法来动态地控制通用查询日志的开启和关闭。</p><p>设置 MySQL 的环境变量<code>general_log</code>为关闭状态可以停止该日志：</p><div class="language-sql" data-highlighter="shiki" data-ext="sql" data-title="sql" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span style="color:#F0F3F6;">mysql</span><span style="color:#FF9492;">&gt;</span><span style="color:#FF9492;"> SET</span><span style="color:#FF9492;"> GLOBAL</span><span style="color:#F0F3F6;"> general_log</span><span style="color:#FF9492;">=off</span><span style="color:#F0F3F6;">;</span></span>
<span class="line"><span style="color:#F0F3F6;">Query OK, </span><span style="color:#91CBFF;">0</span><span style="color:#FF9492;"> rows</span><span style="color:#F0F3F6;"> affected (</span><span style="color:#91CBFF;">0</span><span style="color:#F0F3F6;">.</span><span style="color:#91CBFF;">00</span><span style="color:#F0F3F6;"> sec)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F0F3F6;">mysql</span><span style="color:#FF9492;">&gt;</span><span style="color:#F0F3F6;"> SHOW VARIABLES </span><span style="color:#FF9492;">LIKE</span><span style="color:#ADDCFF;"> &#39;%general_log%&#39;</span><span style="color:#F0F3F6;"> \\G</span></span>
<span class="line"><span style="color:#FF9492;">***************************</span><span style="color:#91CBFF;"> 1</span><span style="color:#F0F3F6;">. </span><span style="color:#FF9492;">row</span><span style="color:#FF9492;"> ***************************</span></span>
<span class="line"><span style="color:#F0F3F6;">Variable_name: general_log</span></span>
<span class="line"><span style="color:#FF9492;">        Value</span><span style="color:#F0F3F6;">: </span><span style="color:#FF9492;">OFF</span></span>
<span class="line"><span style="color:#FF9492;">***************************</span><span style="color:#91CBFF;"> 2</span><span style="color:#F0F3F6;">. </span><span style="color:#FF9492;">row</span><span style="color:#FF9492;"> ***************************</span></span>
<span class="line"><span style="color:#F0F3F6;">Variable_name: general_log_file</span></span>
<span class="line"><span style="color:#FF9492;">        Value</span><span style="color:#F0F3F6;">: C:\\ProgramData\\MySQL\\MySQL </span><span style="color:#FF9492;">Server</span><span style="color:#91CBFF;"> 5</span><span style="color:#F0F3F6;">.</span><span style="color:#91CBFF;">7</span><span style="color:#F0F3F6;">\\</span><span style="color:#FF9492;">Data</span><span style="color:#F0F3F6;">\\LAPTOP</span><span style="color:#FF9492;">-</span><span style="color:#91CBFF;">UHQ6V8KP</span><span style="color:#F0F3F6;">.</span><span style="color:#91CBFF;">log</span></span>
<span class="line"><span style="color:#91CBFF;">2</span><span style="color:#FF9492;"> rows</span><span style="color:#FF9492;"> in</span><span style="color:#FF9492;"> set</span><span style="color:#F0F3F6;">, </span><span style="color:#91CBFF;">1</span><span style="color:#F0F3F6;"> warning (</span><span style="color:#91CBFF;">0</span><span style="color:#F0F3F6;">.</span><span style="color:#91CBFF;">01</span><span style="color:#F0F3F6;"> sec)</span></span></code></pre></div><h4 id="删除通用查询日志" tabindex="-1"><a class="header-anchor" href="#删除通用查询日志"><span>删除通用查询日志</span></a></h4><p>在 MySQL 中，可以使用<code>mysqladmin</code>命令来开启新的通用查询日志。新的通用查询日志会直接覆盖旧的查询日志，不需要再手动删除了。</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" data-title="bash" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span style="color:#FFB757;">mysqladmin</span><span style="color:#91CBFF;"> -uroot</span><span style="color:#91CBFF;"> -p</span><span style="color:#ADDCFF;"> flush-logs</span></span></code></pre></div><p>需要注意的是，如果希望备份旧的通用查询日志，必须先将旧的日志文件拷贝出来或者改名。然后，再执行<code>mysqladmin</code>命令。</p><p>除了上述方法之外，还可以手工删除通用查询日志。删除之后需要重新启动 MySQL 服务。重启之后就会生成新的通用查询日志。如果希望备份旧的日志文件，可以将旧的日志文件改名，然后重启 MySQL 服务。</p><p>由于通用查询日志会记录用户的所有操作，如果数据库的使用非常频繁，通用查询日志将会占用非常大的磁盘空间，对系统性能影响较大。一般情况下，数据管理员可以删除很长时间之前的通用查询日志或关闭此日志，以保证 MySQL 服务器上的硬盘空间。</p><h2 id="慢查询日志" tabindex="-1"><a class="header-anchor" href="#慢查询日志"><span>慢查询日志</span></a></h2><p>慢查询日志用来记录在 MySQL 中执行时间超过指定时间的查询语句。通过慢查询日志，可以查找出哪些查询语句的执行效率低，以便进行优化。</p><p>MySQL 慢查询日志是排查问题的 SQL 语句，以及检查当前 MySQL 性能的一个重要功能。如果不是调优需要，一般不建议启动该参数，因为开启慢查询日志会或多或少带来一定的性能影响。</p><p>默认情况下，慢查询日志功能是关闭的。可以通过以下命令查看是否开启慢查询日志功能。</p><div class="language-sql" data-highlighter="shiki" data-ext="sql" data-title="sql" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span style="color:#F0F3F6;">mysql</span><span style="color:#FF9492;">&gt;</span><span style="color:#F0F3F6;"> SHOW VARIABLES </span><span style="color:#FF9492;">LIKE</span><span style="color:#ADDCFF;"> &#39;slow_query%&#39;</span><span style="color:#F0F3F6;">;</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">---------------------+---------------------------------------------------------------------+</span></span>
<span class="line"><span style="color:#F0F3F6;">| Variable_name       | </span><span style="color:#FF9492;">Value</span><span style="color:#F0F3F6;">                                                               |</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">---------------------+---------------------------------------------------------------------+</span></span>
<span class="line"><span style="color:#F0F3F6;">| slow_query_log      | </span><span style="color:#FF9492;">OFF</span><span style="color:#F0F3F6;">                                                                 |</span></span>
<span class="line"><span style="color:#F0F3F6;">| slow_query_log_file | C:\\ProgramData\\MySQL\\MySQL </span><span style="color:#FF9492;">Server</span><span style="color:#91CBFF;"> 5</span><span style="color:#F0F3F6;">.</span><span style="color:#91CBFF;">7</span><span style="color:#F0F3F6;">\\</span><span style="color:#FF9492;">Data</span><span style="color:#F0F3F6;">\\LAPTOP</span><span style="color:#FF9492;">-</span><span style="color:#F0F3F6;">UHQ6V8KP</span><span style="color:#FF9492;">-</span><span style="color:#91CBFF;">slow</span><span style="color:#F0F3F6;">.</span><span style="color:#91CBFF;">log</span><span style="color:#F0F3F6;"> |</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">---------------------+---------------------------------------------------------------------+</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F0F3F6;">mysql</span><span style="color:#FF9492;">&gt;</span><span style="color:#F0F3F6;"> SHOW VARIABLES </span><span style="color:#FF9492;">LIKE</span><span style="color:#ADDCFF;"> &#39;long_query_time&#39;</span><span style="color:#F0F3F6;">;</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">-----------------+-----------+</span></span>
<span class="line"><span style="color:#F0F3F6;">| Variable_name   | </span><span style="color:#FF9492;">Value</span><span style="color:#F0F3F6;">     |</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">-----------------+-----------+</span></span>
<span class="line"><span style="color:#F0F3F6;">| long_query_time | </span><span style="color:#91CBFF;">10</span><span style="color:#F0F3F6;">.</span><span style="color:#91CBFF;">000000</span><span style="color:#F0F3F6;"> |</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">-----------------+-----------+</span></span></code></pre></div><p>参数说明：</p><ul><li><code>slow_query_log</code>：慢查询开启状态</li><li><code>slow_query_log_file</code>：慢查询日志存放的位置（一般设置为 MySQL 的数据存放目录）</li><li><code>long_query_time</code>：查询超过多少秒才记录</li></ul><h3 id="启动和设置慢查询日志" tabindex="-1"><a class="header-anchor" href="#启动和设置慢查询日志"><span>启动和设置慢查询日志</span></a></h3><p>可以通过<code>log-slow-queries</code>选项开启慢查询日志。通过<code>long_query_time</code>选项来设置时间值，时间以秒为单位。如果查询时间超过了这个时间值，这个查询语句将被记录到慢查询日志。</p><p>将<code>log_slow_queries</code>选项和<code>long_query_time</code>选项加入到配置文件的<code>[mysqld]</code>组中。</p><div class="language-" data-highlighter="shiki" data-ext="" data-title="" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span>[mysqld]</span></span>
<span class="line"><span>log-slow-queries=dir\\filename</span></span>
<span class="line"><span>long_query_time=n</span></span></code></pre></div><p>其中：</p><ul><li><code>dir</code>参数指定慢查询日志的存储路径，如果不指定存储路径，慢查询日志将默认存储到 MySQL 数据库的数据文件夹下。</li><li><code>filename</code>参数指定日志的文件名，生成日志文件的完整名称为<code>filename-slow.log</code>。如果不指定文件名，默认文件名为<code>hostname-slow.log</code>，<code>hostname</code>是 MySQL 服务器的主机名。</li><li><code>n</code>参数是设定的时间值，单位是秒。如果不设置<code>long_query_time</code>选项，默认时间为 10 秒。</li></ul><p>还可以通过以下命令启动慢查询日志、设置指定时间：</p><div class="language-sql" data-highlighter="shiki" data-ext="sql" data-title="sql" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span style="color:#FF9492;">SET</span><span style="color:#FF9492;"> GLOBAL</span><span style="color:#F0F3F6;"> slow_query_log</span><span style="color:#FF9492;">=ON/OFF</span><span style="color:#F0F3F6;">;</span></span>
<span class="line"><span style="color:#FF9492;">SET</span><span style="color:#FF9492;"> GLOBAL</span><span style="color:#F0F3F6;"> long_query_time</span><span style="color:#FF9492;">=</span><span style="color:#F0F3F6;">n;</span></span></code></pre></div><h3 id="查看慢查询日志" tabindex="-1"><a class="header-anchor" href="#查看慢查询日志"><span>查看慢查询日志</span></a></h3><p>如果你想查看哪些查询语句的执行效率低，可以从慢查询日志中获得信息。和错误日志、查询日志一样，慢查询日志也是以文本文件的形式存储的，可以使用普通的文本文件查看工具来查看。</p><p>开启 MySQL 慢查询日志功能，并设置时间：</p><div class="language-sql" data-highlighter="shiki" data-ext="sql" data-title="sql" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span style="color:#F0F3F6;">mysql</span><span style="color:#FF9492;">&gt;</span><span style="color:#FF9492;"> SET</span><span style="color:#FF9492;"> GLOBAL</span><span style="color:#F0F3F6;"> slow_query_log</span><span style="color:#FF9492;">=ON</span><span style="color:#F0F3F6;">;</span></span>
<span class="line"><span style="color:#F0F3F6;">Query OK, </span><span style="color:#91CBFF;">0</span><span style="color:#FF9492;"> rows</span><span style="color:#F0F3F6;"> affected (</span><span style="color:#91CBFF;">0</span><span style="color:#F0F3F6;">.</span><span style="color:#91CBFF;">05</span><span style="color:#F0F3F6;"> sec)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F0F3F6;">mysql</span><span style="color:#FF9492;">&gt;</span><span style="color:#FF9492;"> SET</span><span style="color:#FF9492;"> GLOBAL</span><span style="color:#F0F3F6;"> long_query_time</span><span style="color:#FF9492;">=</span><span style="color:#91CBFF;">0</span><span style="color:#F0F3F6;">.</span><span style="color:#91CBFF;">001</span><span style="color:#F0F3F6;">;</span></span>
<span class="line"><span style="color:#F0F3F6;">Query OK, </span><span style="color:#91CBFF;">0</span><span style="color:#FF9492;"> rows</span><span style="color:#F0F3F6;"> affected (</span><span style="color:#91CBFF;">0</span><span style="color:#F0F3F6;">.</span><span style="color:#91CBFF;">00</span><span style="color:#F0F3F6;"> sec)</span></span></code></pre></div><p>查询<code>tb_student</code>表中的数据：</p><div class="language-sql" data-highlighter="shiki" data-ext="sql" data-title="sql" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span style="color:#F0F3F6;">mysql</span><span style="color:#FF9492;">&gt;</span><span style="color:#FF9492;"> USE</span><span style="color:#F0F3F6;"> test;</span></span>
<span class="line"><span style="color:#FF9492;">Database</span><span style="color:#F0F3F6;"> changed</span></span>
<span class="line"><span style="color:#F0F3F6;">mysql</span><span style="color:#FF9492;">&gt;</span><span style="color:#FF9492;"> SELECT</span><span style="color:#FF9492;"> *</span><span style="color:#FF9492;"> FROM</span><span style="color:#F0F3F6;"> tb_student;</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">----+--------+</span></span>
<span class="line"><span style="color:#F0F3F6;">| id | </span><span style="color:#FF9492;">name</span><span style="color:#F0F3F6;">   |</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">----+--------+</span></span>
<span class="line"><span style="color:#F0F3F6;">|  </span><span style="color:#91CBFF;">1</span><span style="color:#F0F3F6;"> | Java   |</span></span>
<span class="line"><span style="color:#F0F3F6;">|  </span><span style="color:#91CBFF;">2</span><span style="color:#F0F3F6;"> | MySQL  |</span></span>
<span class="line"><span style="color:#F0F3F6;">|  </span><span style="color:#91CBFF;">3</span><span style="color:#F0F3F6;"> | Python |</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">----+--------+</span></span></code></pre></div><p>慢查询日志的部分内容如下：</p><div class="language-" data-highlighter="shiki" data-ext="" data-title="" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span># Time: 2020-06-01T01:59:18.368780Z</span></span>
<span class="line"><span># User@Host: root[root] @ localhost [::1]  Id:     3</span></span>
<span class="line"><span># Query_time: 0.006281  Lock_time: 0.000755 Rows_sent: 2  Rows_examined: 1034</span></span>
<span class="line"><span>use test;</span></span>
<span class="line"><span>SET timestamp=1590976758;</span></span>
<span class="line"><span>SHOW VARIABLES LIKE &#39;slow_query%&#39;;</span></span></code></pre></div><h3 id="删除慢查询日志" tabindex="-1"><a class="header-anchor" href="#删除慢查询日志"><span>删除慢查询日志</span></a></h3><p>慢查询日志的删除方法与通用日志的删除方法是一样的。可以使用<code>mysqladmin</code>命令来删除。也可以使用手工方式来删除。</p><div class="language-" data-highlighter="shiki" data-ext="" data-title="" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span>mysqladmin -uroot -p flush-logs</span></span></code></pre></div><p>执行该命令后，命令行会提示输入密码。输入正确密码后，将执行删除操作。新的慢查询日志会直接覆盖旧的查询日志，不需要再手动删除。</p><p>也可以手工删除慢查询日志，删除之后需要重新启动 MySQL 服务。</p><p>注意：通用查询日志和慢查询日志都是使用这个命令，使用时一定要注意，一旦执行这个命令，通用查询日志和慢查询日志都只存在新的日志文件中。如果需要备份旧的慢查询日志文件，必须先将旧的日志改名，然后重启 MySQL 服务或执行<code>mysqladmin</code>命令。</p><h2 id="设置日志输出方式" tabindex="-1"><a class="header-anchor" href="#设置日志输出方式"><span>设置日志输出方式</span></a></h2><p>MySQL 的查询日志支持写入到文件或写入数据表两种输出形式。启用了普通查询日志或慢查询日志功能后，可以选择让服务器把日志写入到日志文件、<code>mysql</code>数据库中的日志表、或者同时写到这两个地方。</p><p>可以通过以下命令查看日志输出类型：</p><div class="language-sql" data-highlighter="shiki" data-ext="sql" data-title="sql" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span style="color:#F0F3F6;">mysql</span><span style="color:#FF9492;">&gt;</span><span style="color:#F0F3F6;"> SHOW VARIABLES </span><span style="color:#FF9492;">LIKE</span><span style="color:#ADDCFF;"> &#39;%log_out%&#39;</span><span style="color:#F0F3F6;">;</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">---------------+-------+</span></span>
<span class="line"><span style="color:#F0F3F6;">| Variable_name | </span><span style="color:#FF9492;">Value</span><span style="color:#F0F3F6;"> |</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">---------------+-------+</span></span>
<span class="line"><span style="color:#F0F3F6;">| log_output    | </span><span style="color:#FF9492;">FILE</span><span style="color:#F0F3F6;">  |</span></span>
<span class="line"><span style="color:#FF9492;">+</span><span style="color:#BDC4CC;">---------------+-------+</span></span></code></pre></div><p>结果显示，日志输出类型为<code>FILE</code>。</p><p>要想在运行时更改日志输出目标，可以在启动服务器时，设置全局系统变量<code>log_output</code>的值：</p><div class="language-sql" data-highlighter="shiki" data-ext="sql" data-title="sql" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span style="color:#FF9492;">SET</span><span style="color:#FF9492;"> GLOBAL</span><span style="color:#F0F3F6;"> log_output</span><span style="color:#FF9492;">=</span><span style="color:#ADDCFF;">&#39;value&#39;</span><span style="color:#F0F3F6;">;</span></span></code></pre></div><p><code>value</code>的值可以是：</p><ul><li><code>FILE</code>：表示把日志写入到文件。如果未指定<code>log_output</code>的值，默认为<code>FILE</code>。</li><li><code>TABLE</code>：表示把日志写入到<code>mysql</code>数据库的<code>slow_log</code>或<code>general_log</code>表中。</li><li>MySQL 可以同时支持 2 种日志存储方式，配置的时候以逗号隔开，即<code>log_output=&#39;FILE,TABLE&#39;</code>。</li></ul><p>需要注意的是，系统变量<code>log_output</code>只确定了日志使用什么输出目标，并不会启用日志功能。</p><p>相对于写入到文件，日志写入到数据表中要耗费更多的系统资源。因此，对于需要启用查询日志，又需要获得更高的系统性能，建议优先选择将日志写入到文件。</p><p>日志表（<code>slow_log</code>或<code>general_log</code>）中的内容只允许查看，不允许修改，除非服务器自己进行更改。因此，你只能对日志表使用<code>SELECT</code>语句，不能使用<code>INSERT、DELETE</code>或<code>UPDATE</code>语句。不过，可以使用<code>TRUNCATE TABLE</code>语句来清空日志表。</p>`,167)]))}const r=a(e,[["render",p],["__file","MySQL日志.html.vue"]]),i=JSON.parse('{"path":"/sql/mysql/MySQL%E6%97%A5%E5%BF%97.html","title":"MySQL日志","lang":"zh-CN","frontmatter":{"title":"MySQL日志","date":"2024-08-05T00:00:00.000Z","tags":"MySQL","categories":"SQL","order":24,"description":"日志及分类 日志是数据库的重要组成部分，主要用来记录数据库的运行情况、日常操作和错误信息。 MySQL 中的日志可以分为二进制日志、错误日志、通用查询日志和慢查询日志。分析这些日志，可以帮助我们了解 MySQL 数据库的运行情况、日常操作、错误信息和哪些地方需要进行优化。 MySQL 中 4 种日志文件的作用： 二进制日志：该日志文件会以二进制的形式记...","head":[["meta",{"property":"og:url","content":"https://0oWSQo0.github.io/wsq-blog/sql/mysql/MySQL%E6%97%A5%E5%BF%97.html"}],["meta",{"property":"og:title","content":"MySQL日志"}],["meta",{"property":"og:description","content":"日志及分类 日志是数据库的重要组成部分，主要用来记录数据库的运行情况、日常操作和错误信息。 MySQL 中的日志可以分为二进制日志、错误日志、通用查询日志和慢查询日志。分析这些日志，可以帮助我们了解 MySQL 数据库的运行情况、日常操作、错误信息和哪些地方需要进行优化。 MySQL 中 4 种日志文件的作用： 二进制日志：该日志文件会以二进制的形式记..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-04-23T09:49:11.000Z"}],["meta",{"property":"article:published_time","content":"2024-08-05T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-04-23T09:49:11.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"MySQL日志\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2024-08-05T00:00:00.000Z\\",\\"dateModified\\":\\"2025-04-23T09:49:11.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"WSQ\\",\\"url\\":\\"https://0oWSQo0.github.com\\"}]}"]]},"headers":[{"level":2,"title":"日志及分类","slug":"日志及分类","link":"#日志及分类","children":[]},{"level":2,"title":"错误日志","slug":"错误日志","link":"#错误日志","children":[{"level":3,"title":"启动和设置错误日志","slug":"启动和设置错误日志","link":"#启动和设置错误日志","children":[]},{"level":3,"title":"查看错误日志","slug":"查看错误日志","link":"#查看错误日志","children":[]},{"level":3,"title":"删除错误日志","slug":"删除错误日志","link":"#删除错误日志","children":[]}]},{"level":2,"title":"二进制日志","slug":"二进制日志","link":"#二进制日志","children":[{"level":3,"title":"启动和设置二进制日志","slug":"启动和设置二进制日志","link":"#启动和设置二进制日志","children":[]},{"level":3,"title":"查看二进制日志","slug":"查看二进制日志","link":"#查看二进制日志","children":[]},{"level":3,"title":"删除二进制日志","slug":"删除二进制日志","link":"#删除二进制日志","children":[]},{"level":3,"title":"暂时停止二进制日志","slug":"暂时停止二进制日志","link":"#暂时停止二进制日志","children":[]}]},{"level":2,"title":"使用二进制日志还原数据库","slug":"使用二进制日志还原数据库","link":"#使用二进制日志还原数据库","children":[]},{"level":2,"title":"通用查询日志","slug":"通用查询日志","link":"#通用查询日志","children":[{"level":3,"title":"启动和设置通用查询日志","slug":"启动和设置通用查询日志","link":"#启动和设置通用查询日志","children":[]},{"level":3,"title":"查看通用查询日志","slug":"查看通用查询日志","link":"#查看通用查询日志","children":[]},{"level":3,"title":"停止通用查询日志","slug":"停止通用查询日志","link":"#停止通用查询日志","children":[]}]},{"level":2,"title":"慢查询日志","slug":"慢查询日志","link":"#慢查询日志","children":[{"level":3,"title":"启动和设置慢查询日志","slug":"启动和设置慢查询日志","link":"#启动和设置慢查询日志","children":[]},{"level":3,"title":"查看慢查询日志","slug":"查看慢查询日志","link":"#查看慢查询日志","children":[]},{"level":3,"title":"删除慢查询日志","slug":"删除慢查询日志","link":"#删除慢查询日志","children":[]}]},{"level":2,"title":"设置日志输出方式","slug":"设置日志输出方式","link":"#设置日志输出方式","children":[]}],"git":{"createdTime":1730426129000,"updatedTime":1745401751000,"contributors":[{"name":"WSQ","email":"592786982@qq.com","commits":2}]},"readingTime":{"minutes":19.41,"words":5823},"filePathRelative":"sql/mysql/MySQL日志.md","localizedDate":"2024年8月5日","autoDesc":true}');export{r as comp,i as data};
