import{_ as l}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as p,d as e,o}from"./app-BAoNGAQX.js";const n="/wsq-blog/assets/4-BtKgDi-F.png",t="/wsq-blog/assets/img1-L--WMFbh.png",F="/wsq-blog/assets/img2-DxZyrVxz.png",c="/wsq-blog/assets/img3-DvdddYpW.png",r="/wsq-blog/assets/img4-CtAGoFZX.png",i="/wsq-blog/assets/img5-Cy15To0X.png",a="/wsq-blog/assets/6-BS4hNxUr.png",y="/wsq-blog/assets/7-CkM6e-Jf.png",D="/wsq-blog/assets/8-CTZ4zi3X.png",C="/wsq-blog/assets/9-KOLZgXCe.png",A="/wsq-blog/assets/gre-1-qPiOpvwP.png",d="/wsq-blog/assets/gre-2-zZ2uiBn7.png",h="/wsq-blog/assets/gre-3-DP2LgZx-.png",g="/wsq-blog/assets/ike-1-CikwxzN0.png",P="/wsq-blog/assets/ike-2-Ctrs6VK0.png",B="/wsq-blog/assets/ike-3-DLN1NWtX.png",u="/wsq-blog/assets/ike-4-DcWZDdFS.png",R="/wsq-blog/assets/ike-5-DLkoXtSa.png",S={};function E(f,s){return o(),p("div",null,s[0]||(s[0]=[e('<p>VPN 技术还是企业比较常用的通信技术，如果一个企业的分公司和总部的互访，或者出差员工需要访问总部的网络，都会使用 VPN 技术。</p><h2 id="什么是vpn" tabindex="-1"><a class="header-anchor" href="#什么是vpn"><span>什么是VPN</span></a></h2><h3 id="vpn技术出现背景" tabindex="-1"><a class="header-anchor" href="#vpn技术出现背景"><span>VPN技术出现背景</span></a></h3><p>在没有 VPN 之前，企业的总部和分部之间的互通都是采用运营商的 Internet 进行通信，那么 Internet 中往往是不安全的，通信的内容可能被窃取、修改等，从而造成安全事件。</p><p>那么有没有一种技术既能实现总部和分部间的互通，也能够保证数据传输的安全性呢？</p><p>当然有，那就是 VPN。VPN 通过在现有的 Internet 网中构建专用的虚拟网络，实现企业总部和分部的通信，解决了互通、安全、成本的问题。</p><h3 id="什么是-vpn" tabindex="-1"><a class="header-anchor" href="#什么是-vpn"><span>什么是 VPN</span></a></h3><p><code>VPN(Virtual Private Network)</code>即虚拟专用网，指通过 VPN 技术在公有网络中构建专用的虚拟网络。用户在此虚拟网络中传输流量，从而在 Internet 网络中实现安全、可靠的连接。</p><ul><li>专用：VPN 虚拟网络是专门为本机构的主机用于机构内部的通信，而不是用于和网络外非本机构的主机通信。</li><li>虚拟：相对于公有网络而言，VPN 网络是虚拟的，是逻辑意义上的一个专网。</li></ul><figure><img src="'+n+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>RFC 指明了一些专用地址。专用地址只能用作本地地址而不能用作全球地址。在互联网中的所有路由器，对目的地址是专用地址的数据报一律不进行转发。</p><figure><img src="'+t+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>采用这样的专用 IP 地址的互连网络称为专用互联网或就叫做专用网。</p><figure><img src="'+F+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>如果专用网不同网点之间的通信必须经过公用的互联网，但又有保密的要求，那么所有通过互联网传送的数据都必须加密。</p><figure><img src="'+c+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="vpn技术优势" tabindex="-1"><a class="header-anchor" href="#vpn技术优势"><span>VPN技术优势</span></a></h2><ul><li>安全：在远端用户、驻外机构、合作伙伴、供应商与公司总部之间建立可靠的连接，保证数据传输的安全性。这对于实现电子商务或金融网络与通讯网络的融合特别重要。</li><li>成本低：利用公共网络进行信息通讯，企业可以用更低的成本连接远程办事机构、出差人员和业务伙伴。</li><li>支持移动业务：支持出差 VPN 用户在任何时间、任何地点的移动接入，能够满足不断增长的移动业务需求。</li><li>可扩展性：由于 VPN 为逻辑上的网络，物理网络中增加或修改节点，不影响 VPN 的部署。</li></ul><h2 id="内联网和外联网" tabindex="-1"><a class="header-anchor" href="#内联网和外联网"><span>内联网和外联网</span></a></h2><p>它们都是基于 TCP/IP 协议的。</p><p>由部门 A 和 B 的内部网络所构成的虚拟专用网 VPN 又称为内联网(<code>intranet</code>)，表示部门 A 和 B 都是在同一个机构的内部。一个机构和某些外部机构共同建立的虚拟专用网 VPN 又称为外联网(<code>extranet</code>)。</p><figure><img src="'+r+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>远程接入 VPN 可以满足外部流动员工访问公司网络的需求。</p><p>在外地工作的员工拨号接入互联网，而驻留在员工 PC 机中的 VPN 软件可在员工的 PC 机和公司的主机之间建立 VPN 隧道，因而外地员工与公司通信的内容是保密的，员工们感到好像就是使用公司内部的本地网络。</p><h2 id="vpn分类" tabindex="-1"><a class="header-anchor" href="#vpn分类"><span>VPN分类</span></a></h2><h3 id="根据-vpn-建设单位不同进行划分" tabindex="-1"><a class="header-anchor" href="#根据-vpn-建设单位不同进行划分"><span>根据 VPN 建设单位不同进行划分</span></a></h3><h4 id="_1-租用运营商vpn专线搭建企业网络" tabindex="-1"><a class="header-anchor" href="#_1-租用运营商vpn专线搭建企业网络"><span>1. 租用运营商VPN专线搭建企业网络</span></a></h4><p>运营商的专线网络大多数都是使用的MPLS VPN。</p><p>企业通过购买运营商提供的 VPN 专线服务实现总部和分部间的通信需求。VPN网关为运营商所有。</p><figure><img src="'+i+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="_2-企业自建vpn网络" tabindex="-1"><a class="header-anchor" href="#_2-企业自建vpn网络"><span>2. 企业自建VPN网络</span></a></h4><p>企业自己基于 Internet 自建 VPN 网络，常见的如 IPsec VPN、GRE VPN、L2TP VPN。</p><figure><img src="'+a+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="根据组网方式进行划分" tabindex="-1"><a class="header-anchor" href="#根据组网方式进行划分"><span>根据组网方式进行划分</span></a></h3><ol><li>远程访问VPN<br> 这种方式适用于出差员工拨号接入 VPN 的方式，员工可以在只要有 Internet 的地方都可以通过 VPN 接入访问内网资源。<br> 最常见的就是SSL VPN、L2TP VPN。<br><img src="'+n+'" alt="" loading="lazy"></li><li>站点到站点的 VPN<br> 这种方式适用于企业两个局域网互通的情况。例如企业的分部访问总部。最常见的就是 MPLS VPN、IPSEC VPN。<br><img src="'+a+'" alt="" loading="lazy"></li></ol><h3 id="根据工作网络层次进行划分" tabindex="-1"><a class="header-anchor" href="#根据工作网络层次进行划分"><span>根据工作网络层次进行划分</span></a></h3><p>VPN 可以按照工作层次进行划分：</p><ul><li>应用层：SSL VPN</li><li>网络层：IPSEC VPN、GRE VPN</li><li>数据链路层：L2TP VPN、PPTP VPN</li></ul><figure><img src="'+y+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="vpn关键技术" tabindex="-1"><a class="header-anchor" href="#vpn关键技术"><span>VPN关键技术</span></a></h2><h3 id="隧道技术" tabindex="-1"><a class="header-anchor" href="#隧道技术"><span>隧道技术</span></a></h3><p>VPN 技术的基本原理其实就是用的隧道技术，就类似于火车的轨道、地铁的轨道一样，从 A 站点到 B 站点都是直通的，不会堵车。对于乘客而言，就是专车。</p><p>隧道技术其实就是对传输的报文进行封装，利用公网的建立专用的数据传输通道，从而完成数据的安全可靠性传输。</p><figure><img src="'+D+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>可以看到原始报文在隧道的一端进行封装，封装后的数据在公网上传输，在隧道另一端进行解封装，从而实现了数据的安全传输。</p><p>隧道通过隧道协议实现。如<code>GRE（Generic Routing Encapsulation）、L2TP（Layer 2 Tunneling Protocol）</code>等。</p><p>隧道协议通过在隧道的一端给数据加上隧道协议头，即进行封装，使这些被封装的数据能都在某网络中传输，并且在隧道的另一端去掉该数据携带的隧道协议头，即进行解封装。</p><figure><img src="'+C+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="身份认证、数据加密、数据验证" tabindex="-1"><a class="header-anchor" href="#身份认证、数据加密、数据验证"><span>身份认证、数据加密、数据验证</span></a></h3><p>身份认证、数据加密、数据验证可以有效保证 VPN 网络和数据的安全性。</p><ul><li>身份认证：VPN网关对接入VPN的用户进行身份认证，保证接入的用户都是合法用户。</li><li>数据加密：将明文通过加密技术成密文，哪怕信息被获取了，也无法识别。</li><li>数据验证：通过数据验证技术验证报文的完整性和真伪进行检查，防止数据被篡改。</li></ul><table><thead><tr><th style="text-align:center;">VPN</th><th style="text-align:center;">用户身份认证</th><th style="text-align:center;">数据加密和验证</th><th style="text-align:center;">备注</th></tr></thead><tbody><tr><td style="text-align:center;">GRE</td><td style="text-align:center;">不支持</td><td style="text-align:center;">支持简单的关键字验证、校验和验证</td><td style="text-align:center;">可结合 IPSec 使用</td></tr><tr><td style="text-align:center;">L2TP</td><td style="text-align:center;">支持基于 PPP 的CHAP、PAP、EAP 认证</td><td style="text-align:center;">不支持</td><td style="text-align:center;">可结合 IPSec 使用</td></tr><tr><td style="text-align:center;">IPSec</td><td style="text-align:center;">支持</td><td style="text-align:center;">支持</td><td style="text-align:center;">支持预共享密钥验证或证书验证；支持 IKEv2 的 EAP 认证</td></tr><tr><td style="text-align:center;">SSL</td><td style="text-align:center;">支持</td><td style="text-align:center;">支持</td><td style="text-align:center;">支持用户名/密码或证书认证</td></tr><tr><td style="text-align:center;">MPLS</td><td style="text-align:center;">不支持</td><td style="text-align:center;">不支持</td><td style="text-align:center;">一般运行在专用的 VPN 骨干网络</td></tr></tbody></table><h2 id="gre" tabindex="-1"><a class="header-anchor" href="#gre"><span>GRE</span></a></h2><p><code>GRE(Generic Routing Encapsulation)</code>，是一种VPN技术，通过GRE技术，我们能够对网络层数据进行封装，封装后的数据能够在公共网络中传输。</p><figure><img src="'+A+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>我们看上图，两个信息岛屿<code>192.168.1.0/24</code>及<code>192.168.2.0/24</code>要互相通信，一种最直接的办法就是打通全网的路由，让中间的公有传输网络中的所有路由器都有到达这两个网段的路由。但是可能有这样的需求：不希望中间的公有网络知道这两个网段的存在，但是仍然希望他们能够互访。这里就可以使用GRE这种VPN技术。</p><p>GRE的工作机制非常简单，就是在原始的IP报文的基础上，加上一个新的GRE的头部，然后再套上一个新的隧道IP头。这个新的隧道IP头部用于在中间的公有网络中传输被封装的原始IP数据包。这样一来，即使中间公有网络没有<code>192.168.1.0/24</code>及<code>2.0/24</code>的路由，两个信息岛屿也能通过我们预先建立好的隧道进行数据互通，互访数据被隧道边界设备封装上GRE头部以及新的隧道头部，然后送入公有网络，数据包在公有网络中传输时，转发数据包的中间设备只会查看隧道IP头并进行路由，最终数据包被转发到隧道对端的边界路由器上，它将数据包的隧道IP头及GRE头部解除封装，然后将里头承载的原始IP报文转发到目的地。</p><p>GRE的特点：</p><ul><li>可用于在站点之间建立点到点的专用通信隧道；</li><li>GRE头部的通用性非常高，能承载各种类型的上层协议，例如IPv4、IPv6等报文；</li><li>GRE的实现机制及配置非常简单，采用手工方式建立隧道；</li><li>不提供数据加密功能，可配合IPSec来增强安全性；</li><li>不提供QoS能力；</li><li>建立好的GRE隧道支持动态路由协议。</li></ul><h3 id="gre的配置及实现" tabindex="-1"><a class="header-anchor" href="#gre的配置及实现"><span>GRE的配置及实现</span></a></h3><p><img src="'+d+`" alt="" loading="lazy"><br> 网络拓扑如上图所示。其中，R2只配置接口IP地址，并不配置任何静态路由，也不运行动态路由协议。在R1及R2之间建立GRE隧道，使得192.168.1.0/24与192.168.2.0/24网段能够互通。</p><div class="language-shell" data-highlighter="shiki" data-ext="shell" data-title="shell" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span style="color:#F0F3F6;">[R1]interface GigabitEthernet 0/0/0</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-GigabitEthernet0/0/0]ip address 10.1.12.1 24</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-GigabitEthernet0/0/0]quit </span></span>
<span class="line"><span style="color:#F0F3F6;">[R1]interface GigabitEthernet 0/0/1</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-GigabitEthernet0/0/1]ip address 192.168.1.254 24</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-GigabitEthernet0/0/1]quit </span></span>
<span class="line"><span style="color:#F0F3F6;">[R1]ip route-static 0.0.0.0 0 10.1.12.2</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1]interface </span><span style="color:#FF9492;">?</span></span>
<span class="line"><span style="color:#FFB757;">  Bridge-if</span><span style="color:#ADDCFF;">         Bridge-if</span><span style="color:#ADDCFF;"> interface</span></span>
<span class="line"><span style="color:#FFB757;">  Dialer</span><span style="color:#ADDCFF;">            Dialer</span><span style="color:#ADDCFF;"> interface</span></span>
<span class="line"><span style="color:#FFB757;">  Eth-Trunk</span><span style="color:#ADDCFF;">         Ethernet-Trunk</span><span style="color:#ADDCFF;"> interface</span></span>
<span class="line"><span style="color:#FFB757;">  GigabitEthernet</span><span style="color:#ADDCFF;">   GigabitEthernet</span><span style="color:#ADDCFF;"> interface</span></span>
<span class="line"><span style="color:#FFB757;">  Ima-group</span><span style="color:#ADDCFF;">         ATM-IMA</span><span style="color:#ADDCFF;"> interface</span></span>
<span class="line"><span style="color:#FFB757;">  LoopBack</span><span style="color:#ADDCFF;">          LoopBack</span><span style="color:#ADDCFF;"> interface</span></span>
<span class="line"><span style="color:#FFB757;">  MFR</span><span style="color:#ADDCFF;">               MFR</span><span style="color:#ADDCFF;"> interface</span></span>
<span class="line"><span style="color:#FFB757;">  Mp-group</span><span style="color:#ADDCFF;">          Mp-group</span><span style="color:#ADDCFF;"> interface</span></span>
<span class="line"><span style="color:#FFB757;">  NULL</span><span style="color:#ADDCFF;">              NULL</span><span style="color:#ADDCFF;"> interface</span></span>
<span class="line"><span style="color:#FFB757;">  Tunnel</span><span style="color:#ADDCFF;">            Tunnel</span><span style="color:#ADDCFF;"> interface</span></span>
<span class="line"><span style="color:#FFB757;">  Virtual-Ethernet</span><span style="color:#ADDCFF;">  Virtual-Ethernet</span><span style="color:#ADDCFF;"> interface</span></span>
<span class="line"><span style="color:#FFB757;">  Virtual-Template</span><span style="color:#ADDCFF;">  Virtual-Template</span><span style="color:#ADDCFF;"> interface</span></span>
<span class="line"><span style="color:#FFB757;">  Vlanif</span><span style="color:#ADDCFF;">            Vlan</span><span style="color:#ADDCFF;"> interface</span></span>
<span class="line"><span style="color:#FFB757;">  Wlan-Ess</span><span style="color:#ADDCFF;">          Wlan-Ess</span><span style="color:#ADDCFF;"> interface</span></span>
<span class="line"><span style="color:#BDC4CC;"># 创建Tunnel0/0/0接口</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1]interface Tunnel 0/0/0</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-Tunnel0/0/0]tunnel-protocol </span><span style="color:#FF9492;">?</span></span>
<span class="line"><span style="color:#FFB757;">  gre</span><span style="color:#ADDCFF;">        Generic</span><span style="color:#ADDCFF;"> Routing</span><span style="color:#ADDCFF;"> Encapsulation</span></span>
<span class="line"><span style="color:#FFB757;">  ipsec</span><span style="color:#ADDCFF;">      IPSEC</span><span style="color:#ADDCFF;"> Encapsulation</span></span>
<span class="line"><span style="color:#FFB757;">  ipv4-ipv6</span><span style="color:#ADDCFF;">  IP</span><span style="color:#ADDCFF;"> over</span><span style="color:#ADDCFF;"> IPv6</span><span style="color:#ADDCFF;"> encapsulation</span></span>
<span class="line"><span style="color:#FFB757;">  ipv6-ipv4</span><span style="color:#ADDCFF;">  IPv6</span><span style="color:#ADDCFF;"> over</span><span style="color:#ADDCFF;"> IP</span><span style="color:#ADDCFF;"> encapsulation</span></span>
<span class="line"><span style="color:#FFB757;">  mpls</span><span style="color:#ADDCFF;">       MPLS</span><span style="color:#ADDCFF;"> Encapsulation</span></span>
<span class="line"><span style="color:#FFB757;">  none</span><span style="color:#ADDCFF;">       Null</span><span style="color:#ADDCFF;"> Encapsulation</span></span>
<span class="line"><span style="color:#BDC4CC;"># 指定Tunnel接口的协议类型为GRE</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-Tunnel0/0/0]tunnel-protocol gre</span></span>
<span class="line"><span style="color:#BDC4CC;"># 配置Tunnel接口的IP地址</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-Tunnel0/0/0]ip address 1.1.1.1 24</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-Tunnel0/0/0]source </span><span style="color:#FF9492;">?</span></span>
<span class="line"><span style="color:#FFB757;">  GigabitEthernet</span><span style="color:#ADDCFF;">  GigabitEthernet</span><span style="color:#ADDCFF;"> interface</span></span>
<span class="line"><span style="color:#FFB757;">  NULL</span><span style="color:#ADDCFF;">             NULL</span><span style="color:#ADDCFF;"> interface</span></span>
<span class="line"><span style="color:#FFB757;">  Tunnel</span><span style="color:#ADDCFF;">           Tunnel</span><span style="color:#ADDCFF;"> interface</span></span>
<span class="line"><span style="color:#FFB757;">  X.X.X.X</span><span style="color:#ADDCFF;">          IP</span><span style="color:#ADDCFF;"> address</span></span>
<span class="line"><span style="color:#BDC4CC;"># 指定Tunnel的本地源</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-Tunnel0/0/0]source GigabitEthernet 0/0/0</span></span>
<span class="line"><span style="color:#BDC4CC;"># 指定Tunnel的目的地址</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-Tunnel0/0/0]destination </span><span style="color:#FF9492;">?</span></span>
<span class="line"><span style="color:#FFB757;">  X.X.X.X</span><span style="color:#ADDCFF;">       IP</span><span style="color:#ADDCFF;"> address</span></span>
<span class="line"><span style="color:#FFB757;">  vpn-instance</span><span style="color:#ADDCFF;">  VPN</span><span style="color:#ADDCFF;"> Routing/Forwarding</span><span style="color:#ADDCFF;"> parameters</span><span style="color:#ADDCFF;"> on</span><span style="color:#ADDCFF;"> the</span><span style="color:#ADDCFF;"> interface</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-Tunnel0/0/0]destination 10.1.23.3</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-Tunnel0/0/0]quit </span></span>
<span class="line"><span style="color:#BDC4CC;"># 配置静态路由，将去往192.168.2.0/24的流量引导向隧道接口</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1]ip route-static 192.168.2.0 24 Tunnel 0/0/0</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1]display ip routing-table </span></span>
<span class="line"><span style="color:#FFB757;">Route</span><span style="color:#ADDCFF;"> Flags:</span><span style="color:#ADDCFF;"> R</span><span style="color:#ADDCFF;"> -</span><span style="color:#ADDCFF;"> relay,</span><span style="color:#ADDCFF;"> D</span><span style="color:#ADDCFF;"> -</span><span style="color:#ADDCFF;"> download</span><span style="color:#ADDCFF;"> to</span><span style="color:#ADDCFF;"> fib</span></span>
<span class="line"><span style="color:#FFB757;">------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#FFB757;">Routing</span><span style="color:#ADDCFF;"> Tables:</span><span style="color:#ADDCFF;"> Public</span></span>
<span class="line"><span style="color:#FFB757;">         Destinations</span><span style="color:#ADDCFF;"> :</span><span style="color:#91CBFF;"> 15</span><span style="color:#ADDCFF;">       Routes</span><span style="color:#ADDCFF;"> :</span><span style="color:#91CBFF;"> 15</span><span style="color:#F0F3F6;">       </span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFB757;">Destination/Mask</span><span style="color:#ADDCFF;">    Proto</span><span style="color:#ADDCFF;">   Pre</span><span style="color:#ADDCFF;">  Cost</span><span style="color:#ADDCFF;">      Flags</span><span style="color:#ADDCFF;"> NextHop</span><span style="color:#ADDCFF;">         Interface</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFB757;">        0.0.0.0/0</span><span style="color:#ADDCFF;">   Static</span><span style="color:#91CBFF;">  60</span><span style="color:#91CBFF;">   0</span><span style="color:#ADDCFF;">          RD</span><span style="color:#91CBFF;">   10.1.12.2</span><span style="color:#ADDCFF;">       GigabitEthernet0/0/0</span></span>
<span class="line"><span style="color:#FFB757;">        1.1.1.0/24</span><span style="color:#ADDCFF;">  Direct</span><span style="color:#91CBFF;">  0</span><span style="color:#91CBFF;">    0</span><span style="color:#ADDCFF;">           D</span><span style="color:#91CBFF;">   1.1.1.1</span><span style="color:#ADDCFF;">         Tunnel0/0/0</span></span>
<span class="line"><span style="color:#FFB757;">        1.1.1.1/32</span><span style="color:#ADDCFF;">  Direct</span><span style="color:#91CBFF;">  0</span><span style="color:#91CBFF;">    0</span><span style="color:#ADDCFF;">           D</span><span style="color:#91CBFF;">   127.0.0.1</span><span style="color:#ADDCFF;">       Tunnel0/0/0</span></span>
<span class="line"><span style="color:#FFB757;">      1.1.1.255/32</span><span style="color:#ADDCFF;">  Direct</span><span style="color:#91CBFF;">  0</span><span style="color:#91CBFF;">    0</span><span style="color:#ADDCFF;">           D</span><span style="color:#91CBFF;">   127.0.0.1</span><span style="color:#ADDCFF;">       Tunnel0/0/0</span></span>
<span class="line"><span style="color:#FFB757;">      10.1.12.0/24</span><span style="color:#ADDCFF;">  Direct</span><span style="color:#91CBFF;">  0</span><span style="color:#91CBFF;">    0</span><span style="color:#ADDCFF;">           D</span><span style="color:#91CBFF;">   10.1.12.1</span><span style="color:#ADDCFF;">       GigabitEthernet0/0/0</span></span>
<span class="line"><span style="color:#FFB757;">      10.1.12.1/32</span><span style="color:#ADDCFF;">  Direct</span><span style="color:#91CBFF;">  0</span><span style="color:#91CBFF;">    0</span><span style="color:#ADDCFF;">           D</span><span style="color:#91CBFF;">   127.0.0.1</span><span style="color:#ADDCFF;">       GigabitEthernet0/0/0</span></span>
<span class="line"><span style="color:#FFB757;">    10.1.12.255/32</span><span style="color:#ADDCFF;">  Direct</span><span style="color:#91CBFF;">  0</span><span style="color:#91CBFF;">    0</span><span style="color:#ADDCFF;">           D</span><span style="color:#91CBFF;">   127.0.0.1</span><span style="color:#ADDCFF;">       GigabitEthernet0/0/0</span></span>
<span class="line"><span style="color:#FFB757;">      127.0.0.0/8</span><span style="color:#ADDCFF;">   Direct</span><span style="color:#91CBFF;">  0</span><span style="color:#91CBFF;">    0</span><span style="color:#ADDCFF;">           D</span><span style="color:#91CBFF;">   127.0.0.1</span><span style="color:#ADDCFF;">       InLoopBack0</span></span>
<span class="line"><span style="color:#FFB757;">      127.0.0.1/32</span><span style="color:#ADDCFF;">  Direct</span><span style="color:#91CBFF;">  0</span><span style="color:#91CBFF;">    0</span><span style="color:#ADDCFF;">           D</span><span style="color:#91CBFF;">   127.0.0.1</span><span style="color:#ADDCFF;">       InLoopBack0</span></span>
<span class="line"><span style="color:#FFB757;">127.255.255.255/32</span><span style="color:#ADDCFF;">  Direct</span><span style="color:#91CBFF;">  0</span><span style="color:#91CBFF;">    0</span><span style="color:#ADDCFF;">           D</span><span style="color:#91CBFF;">   127.0.0.1</span><span style="color:#ADDCFF;">       InLoopBack0</span></span>
<span class="line"><span style="color:#FFB757;">    192.168.1.0/24</span><span style="color:#ADDCFF;">  Direct</span><span style="color:#91CBFF;">  0</span><span style="color:#91CBFF;">    0</span><span style="color:#ADDCFF;">           D</span><span style="color:#91CBFF;">   192.168.1.254</span><span style="color:#ADDCFF;">   GigabitEthernet0/0/1</span></span>
<span class="line"><span style="color:#FFB757;">  192.168.1.254/32</span><span style="color:#ADDCFF;">  Direct</span><span style="color:#91CBFF;">  0</span><span style="color:#91CBFF;">    0</span><span style="color:#ADDCFF;">           D</span><span style="color:#91CBFF;">   127.0.0.1</span><span style="color:#ADDCFF;">       GigabitEthernet0/0/1</span></span>
<span class="line"><span style="color:#FFB757;">  192.168.1.255/32</span><span style="color:#ADDCFF;">  Direct</span><span style="color:#91CBFF;">  0</span><span style="color:#91CBFF;">    0</span><span style="color:#ADDCFF;">           D</span><span style="color:#91CBFF;">   127.0.0.1</span><span style="color:#ADDCFF;">       GigabitEthernet0/0/1</span></span>
<span class="line"><span style="color:#FFB757;">    192.168.2.0/24</span><span style="color:#ADDCFF;">  Static</span><span style="color:#91CBFF;">  60</span><span style="color:#91CBFF;">   0</span><span style="color:#ADDCFF;">           D</span><span style="color:#91CBFF;">   1.1.1.1</span><span style="color:#ADDCFF;">         Tunnel0/0/0</span></span>
<span class="line"><span style="color:#FFB757;">255.255.255.255/32</span><span style="color:#ADDCFF;">  Direct</span><span style="color:#91CBFF;">  0</span><span style="color:#91CBFF;">    0</span><span style="color:#ADDCFF;">           D</span><span style="color:#91CBFF;">   127.0.0.1</span><span style="color:#ADDCFF;">       InLoopBack0</span></span></code></pre></div><p><code>source gigabitEthernet0/0/0</code>命令用于指定隧道在本设备的源接口，这条命令同时会将隧道的源地址指定为该接口的地址，也即<code>10.1.12.1</code>。使用<code>source 10.1.12.1</code>命令可以实现类似的效<br> 果。</p><div class="language-shell" data-highlighter="shiki" data-ext="shell" data-title="shell" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span style="color:#F0F3F6;">[R2]interface GigabitEthernet 0/0/0</span></span>
<span class="line"><span style="color:#F0F3F6;">[R2-GigabitEthernet0/0/0]ip address 10.1.12.2 24</span></span>
<span class="line"><span style="color:#F0F3F6;">[R2-GigabitEthernet0/0/0]quit</span></span>
<span class="line"><span style="color:#F0F3F6;">[R2]interface GigabitEthernet 0/0/1</span></span>
<span class="line"><span style="color:#F0F3F6;">[R2-GigabitEthernet0/0/1]ip address 10.1.23.2 24</span></span></code></pre></div><div class="language-shell" data-highlighter="shiki" data-ext="shell" data-title="shell" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span style="color:#F0F3F6;">[R3]interface GigabitEthernet 0/0/0</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3-GigabitEthernet0/0/0]ip address 10.1.23.3 24</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3-GigabitEthernet0/0/0]quit </span></span>
<span class="line"><span style="color:#F0F3F6;">[R3]interface GigabitEthernet 0/0/1</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3-GigabitEthernet0/0/1]ip address 192.168.2.254 24</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3-GigabitEthernet0/0/1]quit </span></span>
<span class="line"><span style="color:#F0F3F6;">[R3]ip route-static 0.0.0.0 0 10.1.23.2</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3]interface Tunnel 0/0/0</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3-Tunnel0/0/0]tunnel-protocol gre</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3-Tunnel0/0/0]ip address 1.1.1.2 24</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3-Tunnel0/0/0]source GigabitEthernet 0/0/0</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3-Tunnel0/0/0]destination 10.1.12.1</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3-Tunnel0/0/0]quit</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3]ip route-static 192.168.1.0 24 Tunnel 0/0/0</span></span></code></pre></div><p>完成配置后，PC1 即可与 PC2 相互通信。实际的报文交互过程如下：</p><figure><img src="`+h+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="ipsecvpn" tabindex="-1"><a class="header-anchor" href="#ipsecvpn"><span>IPSecVPN</span></a></h2><h3 id="ipsec协议框架" tabindex="-1"><a class="header-anchor" href="#ipsec协议框架"><span>IPSec协议框架</span></a></h3><p>IPSec 是一种开放的标准框架结构，是由 IETF 指定的标准，是特定的通信方之间在IP层通过加密和数据 摘要（<code>hash</code>）等手段，来保证数据包在公网上传输时的机密性(<code>confidentiality</code>) 、完整性(<code>data integrity</code>)和真实性(<code>origin authentication</code>)等。IPSec 只能工作在 IP 层，要求乘客协议和承载协议都是 IP 协议。</p><p>IPSec 并不是一个单一的协议，而是一个框架。</p><table><thead><tr><th>协议</th><th>说明</th><th></th></tr></thead><tbody><tr><td>IKE(Internet密钥交换协议)</td><td>负责建立和维护SA，重要的功能有：协商协议参数、对等体身份验证、协商密钥及对密钥的管理</td><td></td></tr><tr><td>AH(认证包头协议)</td><td>实际保护流量的安全协议</td><td></td></tr><tr><td>ESP(负载安全封装协议)</td><td>实际保护流量的安全协议</td><td></td></tr></tbody></table><p>IPSec 的框架包含若干个协议。最重要的就是 IKE(<code>Internet Key Exchange</code>) 和两个安全协议（AH、ESP）。其中 IKE（Internet 秘钥交换协议）是核心和根本，这是个混合协议，它包含三个协议：</p><ul><li>Oakley：密钥生成协议，提供了 IPSec 对各种技术的支持。例如对新的加密和散列算法的支持。实际上它是为 IPSec 提供一种框架</li><li>SKEME(<code>Secure Key Exchange Mechanism</code>)：定义密钥交换的机制。</li><li>ISAKMP(<code>Internet Secure Association and Key Management Mechanism</code>)：定义了消息交换的体系结构，包含对等体间消息的格式及状态转变</li></ul><p>其实我们只要关注 ISAKMP 就好了，它是整个 IKE 的核心。ISAKMP 负责 IPSecVPN 中非常重要的几项工作：负责建立和维护 SA（IKE SA 及 IPsecSA）、协商协议 参数（如加密、验证协议等）、对等体身份验证、协商密钥、以及对密钥的管理。ISAKMP 还定义了消 息交换的体系结构，包含对等体之间用于 IPSec 协商的报文格式、状态机等。</p><p>IPSec 协议框架的另一个重要的协议类型：安全协议，它是真正负责保护用户数据的协议，包括两个：AH 及 ESP。</p><ul><li><code>AH(Authentication Header)</code>：认证包头协议，提供数据源认证、数据完整性校验、防重放攻击等功能，不支持数据加密</li><li><code>ESP(Encapsulating Security Payload)</code>：负载安全载荷协议，提供数据源认证、数据完整性校验、防重放攻击、数据加密等功能</li></ul><h3 id="ike的两个阶段" tabindex="-1"><a class="header-anchor" href="#ike的两个阶段"><span>IKE的两个阶段</span></a></h3><figure><img src="'+g+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>当我们在两个站点之间部署 IPSecVPN 时，IPSecVPN 的一个感兴趣报文到达后，将触发 IKE 的工作。IKE 通过两个阶段建立一条安全的 IPSecVPN 隧道，使得受保护的流量能够在公网中安全的传输，这两个阶段就是安全领域经典的 IKE 阶段一及阶段二。</p><h4 id="ike阶段一" tabindex="-1"><a class="header-anchor" href="#ike阶段一"><span>IKE阶段一</span></a></h4><figure><img src="'+P+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>阶段一的主要工作内容是协商安全策略、进行 DH 交换、对等体认证。</p><ul><li>与安全策略协商相关的内容，在华为的设备上的配置就是<code>IKE Proposal</code>，包括用于IKE隧道的加密算法、哈希算法、DH 算法组等策略，两个站点的策略要一致。</li><li>DH 交换就是交换公共值，DH算法是一个神奇的算法，两个站点的防火墙之间通过交换几个公共值，再经过一系列的数学运算，最终得到三把秘钥。而即使有人侦听了DH公共值交换的报文，也无法<br> 推导出这三把秘钥。</li><li>接下去就是对等体的身份认证，最简单的方式就是预共享秘钥的方式，两个站点在防火墙上配置一个统一的密码，如果密码一致则说明两个对等体是可信赖的。</li></ul><p>阶段一完成的标志是 IKE SA 的建立，SA（<code>Security Associations</code>，安全关联）可以简单理解为 IPSec 对等体双方的一共安全共识。</p><p>SA 一共有两种，一种是这里提到的 IKE SA，IKE 对等体双方有一个共同的 IKE SA。另一种 SA 是IPSec SAs，一个 IPSec 会话有两个 IPSec SAs。阶段一有两个模式，我们上文中描述的是主模式，也是应用的较为广泛的模式，另一种模式是野蛮模式。</p><p>阶段一的工作可以理解为是在为阶段二做铺垫，阶段一协商妥当的相关安全策略如加密算法、哈希算法等，都是为了保护第二阶段的相关 ISAKMP 数据。</p><h4 id="ike阶段二" tabindex="-1"><a class="header-anchor" href="#ike阶段二"><span>IKE阶段二</span></a></h4><figure><img src="'+B+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>IKE 第一阶段完成后，就会进入 IKE 第二阶段，在阶段二最主要的任务是明确第二阶段的策略（在华为设备的配置中就是<code>IPSec Proposal</code>），这些策略包括加密算法、哈希算法等等，注意，这里的这些策略，要和阶段一的策略区分开来，这里所协商的策略是最终用于保护实际业务流量的策略，而阶段一的那些 策略是用于保护 IPSec 协商的数据（主要是为了保护 IKE 阶段二的协商过程）。</p><p>阶段二完成的标志是双方都明确了 IPSec SAs，这里的 IPSec SAs 实际上是包含两个 SA：入站及出站。FW1 上的出站 SA 用于保护从 FW1 发往 FW2 的数据，这个 SA 对应 FW2 上的入站 SA，而 FW1 的入站 SA 对应 FW2 的出站 SA。</p><h4 id="ike两个阶段完成后" tabindex="-1"><a class="header-anchor" href="#ike两个阶段完成后"><span>IKE两个阶段完成后：</span></a></h4><p>IKE 两个阶段完成后，IPSecVPN 的隧道就算是建立起来了，上面说了标志性的里程碑就是 IPSec SAs 的建立，如果 IPSecVPN 隧道正确建立，站点的 IPSecVPN 安全设备上应该有两个 IPSec SAs，一个是出站的 outbound SA，一个是入站的 Inbound SA。站点 1 的出站 SA 对应站点 2 的入站 SA，站点1 的入站 SA 对应站点 2 的出站 SA，如下图所示。</p><figure><img src="'+u+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>IPSec SAs 中保存着双方协商好的加密算法、哈希算法、秘钥信息等等。当站点 1 的 FW 收到来自本地内网的流量，如果该流量匹配了 IPSecVPN 的感兴趣数据流，它就会根据出站 SA 中指示的加密算法，以及秘钥对数据进行加密，并做加密后的数据做哈希，将处理好的数据封装在 ESP（安全协议，此处以 ESP 为例）后，并在ESP头部中写入明确SA的SPI（索引值，这个索引值对应<code>Site2-FW</code>的入站 SA），然后再封装上新的 IP 头以便数据能够在公网中传输。</p><p><code>Site2-FW</code>收到数据后，将隧道 IP 头部去除，发现里头是个 ESP 封装的报文，于是从 ESP 头部中的 SPI 在本地查找，找到 SPI 值对应的 SA，也就是匹配的入站 SA，将数据做完整性校验，校验通过后对数据进行解密，最后得到明文的原始报文，然后将报文传递到本地内网目标节点。</p><h3 id="路由器上的lan-to-lan-ipsec-vpn-ike协商" tabindex="-1"><a class="header-anchor" href="#路由器上的lan-to-lan-ipsec-vpn-ike协商"><span>路由器上的LAN-to-LAN IPSec VPN（IKE协商）</span></a></h3><h4 id="实验拓扑" tabindex="-1"><a class="header-anchor" href="#实验拓扑"><span>实验拓扑</span></a></h4><figure><img src="'+R+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="实验要求" tabindex="-1"><a class="header-anchor" href="#实验要求"><span>实验要求</span></a></h4><ul><li>在 R1 及 R3 上配置高级 ACL 用于匹配 IPSecVPN 感兴趣流量。</li><li>在 R1 及 R3 上创建<code>IKE Proposal</code>，用于指定 IKE 阶段一的策略。</li><li>在 R1 及 R3 上配置<code>IKE peer</code>，用于指示对等体（地址等信息）。在本例中，使用的是域共享秘钥的方式进行对等体身份验证。</li><li>在 R1 及 R3 上创建<code>IPSec Proposal</code>，用于指定 IKE 阶段二的策略，以便协商 IPSec SA。</li><li>在 R1 及 R3 上创建<code>IPSec Policy</code>，用于将<code>ACL、IKE Proposal、IPSec Proposal、IKE Peer</code>等信息进行关联。</li><li>在 R1 及 R3 上将<code>IPSec Policy</code>应用在接口上。</li></ul><h4 id="实验步骤" tabindex="-1"><a class="header-anchor" href="#实验步骤"><span>实验步骤</span></a></h4><div class="language-shell" data-highlighter="shiki" data-ext="shell" data-title="shell" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span style="color:#F0F3F6;">[R1]interface GigabitEthernet 0/0/0</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-GigabitEthernet0/0/0]ip address 200.1.1.1 24</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-GigabitEthernet0/0/0]quit</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1]interface GigabitEthernet 0/0/1</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-GigabitEthernet0/0/1]ip address 192.168.1.254 24</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-GigabitEthernet0/0/1]quit</span></span>
<span class="line"><span style="color:#BDC4CC;"># R1配置IPSecVPN感兴趣数据流，这些流量将会被IPSecVPN保护</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1]acl 3000</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-acl-adv-3000]rule permit </span><span style="color:#FF9492;">?</span></span>
<span class="line"><span style="color:#FF9492;">  &lt;</span><span style="color:#FFB757;">1-255</span><span style="color:#F0F3F6;">&gt;  </span><span style="color:#ADDCFF;">Protocol</span><span style="color:#ADDCFF;"> number</span></span>
<span class="line"><span style="color:#FFB757;">  gre</span><span style="color:#ADDCFF;">      GRE</span><span style="color:#ADDCFF;"> tunneling</span><span style="color:#F0F3F6;">(</span><span style="color:#FFB757;">47</span><span style="color:#F0F3F6;">)</span></span>
<span class="line"><span style="color:#FFB757;">  icmp</span><span style="color:#ADDCFF;">     Internet</span><span style="color:#ADDCFF;"> Control</span><span style="color:#ADDCFF;"> Message</span><span style="color:#ADDCFF;"> Protocol</span><span style="color:#F0F3F6;">(</span><span style="color:#FFB757;">1</span><span style="color:#F0F3F6;">)</span></span>
<span class="line"><span style="color:#FFB757;">  igmp</span><span style="color:#ADDCFF;">     Internet</span><span style="color:#ADDCFF;"> Group</span><span style="color:#ADDCFF;"> Management</span><span style="color:#ADDCFF;"> Protocol</span><span style="color:#F0F3F6;">(</span><span style="color:#FFB757;">2</span><span style="color:#F0F3F6;">)</span></span>
<span class="line"><span style="color:#FFB757;">  ip</span><span style="color:#ADDCFF;">       Any</span><span style="color:#ADDCFF;"> IP</span><span style="color:#ADDCFF;"> protocol</span></span>
<span class="line"><span style="color:#FFB757;">  ipinip</span><span style="color:#ADDCFF;">   IP</span><span style="color:#ADDCFF;"> in</span><span style="color:#ADDCFF;"> IP</span><span style="color:#ADDCFF;"> tunneling</span><span style="color:#F0F3F6;">(</span><span style="color:#FFB757;">4</span><span style="color:#F0F3F6;">)</span></span>
<span class="line"><span style="color:#FFB757;">  ospf</span><span style="color:#ADDCFF;">     OSPF</span><span style="color:#ADDCFF;"> routing</span><span style="color:#ADDCFF;"> protocol</span><span style="color:#F0F3F6;">(</span><span style="color:#FFB757;">89</span><span style="color:#F0F3F6;">)</span></span>
<span class="line"><span style="color:#FFB757;">  tcp</span><span style="color:#ADDCFF;">      Transmission</span><span style="color:#ADDCFF;"> Control</span><span style="color:#ADDCFF;"> Protocol</span><span style="color:#F0F3F6;"> (6)</span></span>
<span class="line"><span style="color:#FFB757;">  udp</span><span style="color:#ADDCFF;">      User</span><span style="color:#ADDCFF;"> Datagram</span><span style="color:#ADDCFF;"> Protocol</span><span style="color:#F0F3F6;"> (17)</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-acl-adv-3000]rule permit ip source 192.168.1.0 0.0.0.255 destination 192.168.2.0 0.0.0.255</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-acl-adv-3000]quit</span></span>
<span class="line"><span style="color:#BDC4CC;"># 配置默认路由，使得R1与R3能够互通</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1]ip route-static 0.0.0.0 0 200.1.1.2</span></span>
<span class="line"><span style="color:#BDC4CC;"># R1配置IKE阶段一的策略IKE Proposal</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1]ike </span><span style="color:#FF9492;">?</span></span>
<span class="line"><span style="color:#FFB757;">  heartbeat</span><span style="color:#ADDCFF;">            IKE</span><span style="color:#ADDCFF;"> heartbeat</span><span style="color:#ADDCFF;"> detection</span></span>
<span class="line"><span style="color:#FFB757;">  heartbeat-timer</span><span style="color:#ADDCFF;">      Specify</span><span style="color:#ADDCFF;"> IKE</span><span style="color:#ADDCFF;"> heartbeat</span><span style="color:#ADDCFF;"> timer</span></span>
<span class="line"><span style="color:#FFB757;">  local-name</span><span style="color:#ADDCFF;">           Set</span><span style="color:#ADDCFF;"> local</span><span style="color:#ADDCFF;"> ID</span></span>
<span class="line"><span style="color:#FFB757;">  nat-keepalive-timer</span><span style="color:#ADDCFF;">  Set</span><span style="color:#ADDCFF;"> the</span><span style="color:#ADDCFF;"> keepalive</span><span style="color:#ADDCFF;"> Interval</span><span style="color:#ADDCFF;"> parameter</span></span>
<span class="line"><span style="color:#FFB757;">  peer</span><span style="color:#ADDCFF;">                 Specify</span><span style="color:#ADDCFF;"> IKE</span><span style="color:#ADDCFF;"> peer</span></span>
<span class="line"><span style="color:#FFB757;">  proposal</span><span style="color:#ADDCFF;">             Config</span><span style="color:#ADDCFF;"> an</span><span style="color:#ADDCFF;"> IKE</span><span style="color:#ADDCFF;"> security</span><span style="color:#ADDCFF;"> proposal</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1]ike proposal 1</span></span>
<span class="line"><span style="color:#BDC4CC;"># 加密算法</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-ike-proposal-1]encryption-algorithm </span><span style="color:#FF9492;">?</span></span>
<span class="line"><span style="color:#FFB757;">  3des-cbc</span><span style="color:#91CBFF;">     168</span><span style="color:#ADDCFF;"> bits</span><span style="color:#ADDCFF;"> 3DES-CBC</span></span>
<span class="line"><span style="color:#FFB757;">  aes-cbc-128</span><span style="color:#ADDCFF;">  Use</span><span style="color:#ADDCFF;"> AES-128</span></span>
<span class="line"><span style="color:#FFB757;">  aes-cbc-192</span><span style="color:#ADDCFF;">  Use</span><span style="color:#ADDCFF;"> AES-192</span></span>
<span class="line"><span style="color:#FFB757;">  aes-cbc-256</span><span style="color:#ADDCFF;">  Use</span><span style="color:#ADDCFF;"> AES-256</span></span>
<span class="line"><span style="color:#FFB757;">  des-cbc</span><span style="color:#91CBFF;">      56</span><span style="color:#ADDCFF;"> bits</span><span style="color:#ADDCFF;"> DES-CBC</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-ike-proposal-1]encryption-algorithm aes-cbc-128</span></span>
<span class="line"><span style="color:#BDC4CC;"># 哈希算法</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-ike-proposal-1]authentication-algorithm </span><span style="color:#FF9492;">?</span></span>
<span class="line"><span style="color:#FFB757;">  aes-xcbc-mac-96</span><span style="color:#ADDCFF;">  Select</span><span style="color:#ADDCFF;"> aes-xcbc-mac-96</span><span style="color:#ADDCFF;"> as</span><span style="color:#ADDCFF;"> the</span><span style="color:#ADDCFF;"> hash</span><span style="color:#ADDCFF;"> algorithm</span></span>
<span class="line"><span style="color:#FFB757;">  md5</span><span style="color:#ADDCFF;">              Select</span><span style="color:#ADDCFF;"> MD5</span><span style="color:#ADDCFF;"> as</span><span style="color:#ADDCFF;"> the</span><span style="color:#ADDCFF;"> hash</span><span style="color:#ADDCFF;"> algorithm</span></span>
<span class="line"><span style="color:#FFB757;">  sha1</span><span style="color:#ADDCFF;">             Select</span><span style="color:#ADDCFF;"> SHA</span><span style="color:#ADDCFF;"> as</span><span style="color:#ADDCFF;"> the</span><span style="color:#ADDCFF;"> hash</span><span style="color:#ADDCFF;"> algorithm</span></span>
<span class="line"><span style="color:#FFB757;">  sm3</span><span style="color:#ADDCFF;">              Select</span><span style="color:#ADDCFF;"> sm3</span><span style="color:#ADDCFF;"> as</span><span style="color:#ADDCFF;"> the</span><span style="color:#ADDCFF;"> hash</span><span style="color:#ADDCFF;"> algorithm</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-ike-proposal-1]authentication-algorithm sha1 </span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-ike-proposal-1]quit</span></span>
<span class="line"><span style="color:#BDC4CC;"># R1配置对等体信息，用于IKE阶段一的身份验证</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1]ike peer </span><span style="color:#FF9492;">?</span></span>
<span class="line"><span style="color:#FFB757;">  STRING</span><span style="color:#F0F3F6;">&lt;1-15&gt;   </span><span style="color:#ADDCFF;">IKE</span><span style="color:#ADDCFF;"> peer</span><span style="color:#ADDCFF;"> name,</span><span style="color:#ADDCFF;"> up</span><span style="color:#ADDCFF;"> to</span><span style="color:#91CBFF;"> 15</span><span style="color:#ADDCFF;"> characters</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1]ike peer R3 </span><span style="color:#FF9492;">?</span></span>
<span class="line"><span style="color:#FFB757;">  v1</span><span style="color:#ADDCFF;">    Only</span><span style="color:#ADDCFF;"> V1</span><span style="color:#ADDCFF;"> SA&#39;s can be created</span></span>
<span class="line"><span style="color:#ADDCFF;">  v2    Only V2 SA&#39;s</span><span style="color:#ADDCFF;"> can</span><span style="color:#ADDCFF;"> be</span><span style="color:#ADDCFF;"> created</span></span>
<span class="line"><span style="color:#FF9492;">  &lt;</span><span style="color:#FFB757;">cr</span><span style="color:#F0F3F6;">&gt;  </span><span style="color:#ADDCFF;">Please</span><span style="color:#ADDCFF;"> press</span><span style="color:#ADDCFF;"> ENTER</span><span style="color:#ADDCFF;"> to</span><span style="color:#ADDCFF;"> execute</span><span style="color:#ADDCFF;"> command</span><span style="color:#F0F3F6;"> </span></span>
<span class="line"><span style="color:#F0F3F6;">[R1]ike peer R3 v1</span></span>
<span class="line"><span style="color:#BDC4CC;"># 关联上面定义的IKE Proposal 1</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-ike-peer-R3]ike-proposal 1</span></span>
<span class="line"><span style="color:#BDC4CC;"># 配置用于身份认证的密码</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-ike-peer-R3]pre-shared-key </span><span style="color:#FF9492;">?</span></span>
<span class="line"><span style="color:#FFB757;">  cipher</span><span style="color:#ADDCFF;">  Pre-shared-key</span><span style="color:#ADDCFF;"> with</span><span style="color:#ADDCFF;"> cipher</span><span style="color:#ADDCFF;"> text</span></span>
<span class="line"><span style="color:#FFB757;">  simple</span><span style="color:#ADDCFF;">  Pre-shared-key</span><span style="color:#ADDCFF;"> with</span><span style="color:#ADDCFF;"> plain</span><span style="color:#ADDCFF;"> text</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-ike-peer-R3]pre-shared-key cipher Huawei123</span></span>
<span class="line"><span style="color:#BDC4CC;"># 对等体的地址</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-ike-peer-R3]remote-address 200.2.2.2</span></span>
<span class="line"><span style="color:#BDC4CC;"># 本设备的地址</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-ike-peer-R3]local-address 200.1.1.1</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-ike-peer-R3]quit</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1]ipsec </span><span style="color:#FF9492;">?</span></span>
<span class="line"><span style="color:#FFB757;">  anti-replay</span><span style="color:#ADDCFF;">      Config</span><span style="color:#ADDCFF;"> IPSec</span><span style="color:#ADDCFF;"> Anti</span><span style="color:#ADDCFF;"> replay</span></span>
<span class="line"><span style="color:#FFB757;">  decrypt</span><span style="color:#ADDCFF;">          Decrypt</span></span>
<span class="line"><span style="color:#FFB757;">  df-bit</span><span style="color:#ADDCFF;">           Set</span><span style="color:#ADDCFF;"> the</span><span style="color:#ADDCFF;"> df-bit</span><span style="color:#ADDCFF;"> value</span></span>
<span class="line"><span style="color:#FFB757;">  efficient-vpn</span><span style="color:#ADDCFF;">    Efficient-vpn</span></span>
<span class="line"><span style="color:#FFB757;">  fragmentation</span><span style="color:#ADDCFF;">    Set</span><span style="color:#ADDCFF;"> fragmentation</span></span>
<span class="line"><span style="color:#FFB757;">  policy</span><span style="color:#ADDCFF;">           Config</span><span style="color:#ADDCFF;"> IPSec</span><span style="color:#ADDCFF;"> security</span><span style="color:#ADDCFF;"> policy</span></span>
<span class="line"><span style="color:#FFB757;">  policy-template</span><span style="color:#ADDCFF;">  Policy</span><span style="color:#ADDCFF;"> template</span></span>
<span class="line"><span style="color:#FFB757;">  profile</span><span style="color:#ADDCFF;">          Config</span><span style="color:#ADDCFF;"> IPSec</span><span style="color:#ADDCFF;"> security</span><span style="color:#ADDCFF;"> profile</span></span>
<span class="line"><span style="color:#FFB757;">  proposal</span><span style="color:#ADDCFF;">         Config</span><span style="color:#ADDCFF;"> IPSec</span><span style="color:#ADDCFF;"> security</span><span style="color:#ADDCFF;"> proposal</span></span>
<span class="line"><span style="color:#FFB757;">  remote</span><span style="color:#ADDCFF;">           Remote</span><span style="color:#ADDCFF;"> side</span></span>
<span class="line"><span style="color:#FFB757;">  sa</span><span style="color:#ADDCFF;">               Specify</span><span style="color:#ADDCFF;"> the</span><span style="color:#ADDCFF;"> parameters</span><span style="color:#ADDCFF;"> of</span><span style="color:#ADDCFF;"> security</span><span style="color:#ADDCFF;"> association</span><span style="color:#F0F3F6;">(</span><span style="color:#FFB757;">SA</span><span style="color:#F0F3F6;">)</span></span>
<span class="line"><span style="color:#BDC4CC;"># R1配置IKE阶段二的策略IPSec Proposal</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1]ipsec proposal myset</span></span>
<span class="line"><span style="color:#BDC4CC;"># 安全协议</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-ipsec-proposal-myset]transform </span><span style="color:#FF9492;">?</span></span>
<span class="line"><span style="color:#FFB757;">  ah</span><span style="color:#ADDCFF;">      AH</span><span style="color:#ADDCFF;"> protocol</span><span style="color:#ADDCFF;"> defined</span><span style="color:#ADDCFF;"> in</span><span style="color:#ADDCFF;"> RFC2402</span></span>
<span class="line"><span style="color:#FFB757;">  ah-esp</span><span style="color:#ADDCFF;">  ESP</span><span style="color:#ADDCFF;"> protocol</span><span style="color:#ADDCFF;"> first,</span><span style="color:#ADDCFF;"> then</span><span style="color:#ADDCFF;"> AH</span><span style="color:#ADDCFF;"> protocol</span></span>
<span class="line"><span style="color:#FFB757;">  esp</span><span style="color:#ADDCFF;">     ESP</span><span style="color:#ADDCFF;"> protocol</span><span style="color:#ADDCFF;"> defined</span><span style="color:#ADDCFF;"> in</span><span style="color:#ADDCFF;"> RFC2406</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-ipsec-proposal-myset]transform esp</span></span>
<span class="line"><span style="color:#BDC4CC;"># 哈希算法</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-ipsec-proposal-myset]esp authentication-algorithm sha1</span></span>
<span class="line"><span style="color:#BDC4CC;"># 加密算法</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-ipsec-proposal-myset]esp encryption-algorithm </span><span style="color:#FF9492;">?</span></span>
<span class="line"><span style="color:#FFB757;">  3des</span><span style="color:#ADDCFF;">     Use</span><span style="color:#ADDCFF;"> 3DES</span></span>
<span class="line"><span style="color:#FFB757;">  aes-128</span><span style="color:#ADDCFF;">  Use</span><span style="color:#ADDCFF;"> AES-128</span></span>
<span class="line"><span style="color:#FFB757;">  aes-192</span><span style="color:#ADDCFF;">  Use</span><span style="color:#ADDCFF;"> AES-192</span></span>
<span class="line"><span style="color:#FFB757;">  aes-256</span><span style="color:#ADDCFF;">  Use</span><span style="color:#ADDCFF;"> AES-256</span></span>
<span class="line"><span style="color:#FFB757;">  des</span><span style="color:#ADDCFF;">      Use</span><span style="color:#ADDCFF;"> DES</span></span>
<span class="line"><span style="color:#FFB757;">  sm1</span><span style="color:#ADDCFF;">      Use</span><span style="color:#ADDCFF;"> SM1</span></span>
<span class="line"><span style="color:#FF9492;">  &lt;</span><span style="color:#FFB757;">cr</span><span style="color:#F0F3F6;">&gt;     </span><span style="color:#ADDCFF;">Please</span><span style="color:#ADDCFF;"> press</span><span style="color:#ADDCFF;"> ENTER</span><span style="color:#ADDCFF;"> to</span><span style="color:#ADDCFF;"> execute</span><span style="color:#ADDCFF;"> command</span><span style="color:#F0F3F6;"> </span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-ipsec-proposal-myset]esp encryption-algorithm 3	</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-ipsec-proposal-myset]esp encryption-algorithm 3des </span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-ipsec-proposal-myset]quit</span></span>
<span class="line"><span style="color:#BDC4CC;"># R1上完成IPsec Policy的配置</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1]ipsec policy </span><span style="color:#FF9492;">?</span></span>
<span class="line"><span style="color:#FFB757;">  STRING</span><span style="color:#F0F3F6;">&lt;1-15&gt;   </span><span style="color:#ADDCFF;">Name</span><span style="color:#ADDCFF;"> of</span><span style="color:#ADDCFF;"> IPSec</span><span style="color:#ADDCFF;"> security</span><span style="color:#ADDCFF;"> policy</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1]ipsec policy mypolicy </span><span style="color:#FF9492;">?</span></span>
<span class="line"><span style="color:#FFB757;">  INTEGER</span><span style="color:#F0F3F6;">&lt;1-10000&gt;  </span><span style="color:#ADDCFF;">The</span><span style="color:#ADDCFF;"> sequence</span><span style="color:#ADDCFF;"> number</span><span style="color:#ADDCFF;"> of</span><span style="color:#ADDCFF;"> IPSec</span><span style="color:#ADDCFF;"> policy</span></span>
<span class="line"><span style="color:#FFB757;">  shared</span><span style="color:#ADDCFF;">            Shared</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1]ipsec policy mypolicy 10 </span><span style="color:#FF9492;">?</span></span>
<span class="line"><span style="color:#FFB757;">  isakmp</span><span style="color:#ADDCFF;">  Indicates</span><span style="color:#ADDCFF;"> use</span><span style="color:#ADDCFF;"> IKE</span><span style="color:#ADDCFF;"> to</span><span style="color:#ADDCFF;"> establish</span><span style="color:#ADDCFF;"> the</span><span style="color:#ADDCFF;"> IPSec</span><span style="color:#ADDCFF;"> SA</span></span>
<span class="line"><span style="color:#FFB757;">  manual</span><span style="color:#ADDCFF;">  Indicates</span><span style="color:#ADDCFF;"> use</span><span style="color:#ADDCFF;"> manual</span><span style="color:#ADDCFF;"> to</span><span style="color:#ADDCFF;"> establish</span><span style="color:#ADDCFF;"> the</span><span style="color:#ADDCFF;"> IPSec</span><span style="color:#ADDCFF;"> SA</span></span>
<span class="line"><span style="color:#FF9492;">  &lt;</span><span style="color:#FFB757;">cr</span><span style="color:#F0F3F6;">&gt;    </span><span style="color:#ADDCFF;">Please</span><span style="color:#ADDCFF;"> press</span><span style="color:#ADDCFF;"> ENTER</span><span style="color:#ADDCFF;"> to</span><span style="color:#ADDCFF;"> execute</span><span style="color:#ADDCFF;"> command</span><span style="color:#F0F3F6;"> </span></span>
<span class="line"><span style="color:#F0F3F6;">[R1]ipsec policy mypolicy 10 isakmp</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-ipsec-policy-isakmp-mypolicy-10]security </span><span style="color:#FF9492;">?</span></span>
<span class="line"><span style="color:#FFB757;">  acl</span><span style="color:#ADDCFF;">  Specify</span><span style="color:#ADDCFF;"> the</span><span style="color:#ADDCFF;"> packets</span><span style="color:#ADDCFF;"> by</span><span style="color:#ADDCFF;"> acl</span></span>
<span class="line"><span style="color:#BDC4CC;"># 关联上面定义好的ACL3000</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-ipsec-policy-isakmp-mypolicy-10]security acl 3000</span></span>
<span class="line"><span style="color:#BDC4CC;"># 关联上面定义好的IPSec Proposal</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-ipsec-policy-isakmp-mypolicy-10]proposal myset</span></span>
<span class="line"><span style="color:#BDC4CC;"># 指定对等体</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-ipsec-policy-isakmp-mypolicy-10]ike-peer R3</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-ipsec-policy-isakmp-mypolicy-10]quit</span></span>
<span class="line"><span style="color:#BDC4CC;"># 在R1的出接口应用IPSecPolicy</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1]interface GigabitEthernet 0/0/0</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-GigabitEthernet0/0/0]ipsec </span><span style="color:#FF9492;">?</span></span>
<span class="line"><span style="color:#FFB757;">  efficient-vpn</span><span style="color:#ADDCFF;">  Efficient-vpn</span></span>
<span class="line"><span style="color:#FFB757;">  policy</span><span style="color:#ADDCFF;">         Config</span><span style="color:#ADDCFF;"> IPSec</span><span style="color:#ADDCFF;"> security</span><span style="color:#ADDCFF;"> policy</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-GigabitEthernet0/0/0]ipsec policy </span><span style="color:#FF9492;">?</span></span>
<span class="line"><span style="color:#FFB757;">  STRING</span><span style="color:#F0F3F6;">&lt;1-15&gt;   </span><span style="color:#ADDCFF;">Name</span><span style="color:#ADDCFF;"> of</span><span style="color:#ADDCFF;"> IPSec</span><span style="color:#ADDCFF;"> security</span><span style="color:#ADDCFF;"> policy</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1-GigabitEthernet0/0/0]ipsec policy mypolicy</span></span></code></pre></div><div class="language-shell" data-highlighter="shiki" data-ext="shell" data-title="shell" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span style="color:#F0F3F6;">[R3]interface GigabitEthernet 0/0/0</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3-GigabitEthernet0/0/0]ip address 200.2.2.2 24</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3-GigabitEthernet0/0/0]quit</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3]interface GigabitEthernet 0/0/1</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3-GigabitEthernet0/0/1]ip address 192.168.2.254 24</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3-GigabitEthernet0/0/1]quit</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F0F3F6;">[R3]acl 3000</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3-acl-adv-3000]rule permit ip source 192.168.2.0 0.0.0.255 destination 192.168.1.0 0.0.0.255</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3-acl-adv-3000]quit</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F0F3F6;">[R3]ip route-static 0.0.0.0 0 200.2.2.1</span></span>
<span class="line"><span style="color:#BDC4CC;"># R3配置IKE阶段一的策略IKE Proposal</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3]ike proposal 1</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3-ike-proposal-1]encryption-algorithm aes-cbc-128</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3-ike-proposal-1]authentication-algorithm sha1 </span></span>
<span class="line"><span style="color:#F0F3F6;">[R3-ike-proposal-1]quit</span></span>
<span class="line"><span style="color:#BDC4CC;"># R3配置对等体信息，用于IKE阶段一的身份验证</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3]ike peer R1 v1</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3-ike-peer-R1]ike-proposal 1</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3-ike-peer-R1]pre-shared-key cipher Huawei123</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3-ike-peer-R1]remote-address 200.1.1.1</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3-ike-peer-R1]local-address 200.2.2.2</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3-ike-peer-R1]quit</span></span>
<span class="line"><span style="color:#BDC4CC;"># R3配置IKE阶段二的策略IPSec Proposal</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3]ipsec proposal myset</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3-ipsec-proposal-myset]transform esp</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3-ipsec-proposal-myset]esp authentication-algorithm sha1</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3-ipsec-proposal-myset]esp encryption-algorithm 3des </span></span>
<span class="line"><span style="color:#F0F3F6;">[R3-ipsec-proposal-myset]quit</span></span>
<span class="line"><span style="color:#BDC4CC;"># R3上完成IPsec Policy的配置</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3]ipsec policy mypolicy 10 isakmp</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3-ipsec-policy-isakmp-mypolicy-10]security acl 3000</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3-ipsec-policy-isakmp-mypolicy-10]proposal myset</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3-ipsec-policy-isakmp-mypolicy-10]ike-peer R1</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3-ipsec-policy-isakmp-mypolicy-10]quit</span></span>
<span class="line"><span style="color:#BDC4CC;"># 在R3的出接口应用IPSecPolicy</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3]interface GigabitEthernet 0/0/0</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3-GigabitEthernet0/0/0]ipsec policy mypolicy</span></span></code></pre></div><div class="language-shell" data-highlighter="shiki" data-ext="shell" data-title="shell" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span style="color:#F0F3F6;">[R2]interface GigabitEthernet 0/0/0</span></span>
<span class="line"><span style="color:#F0F3F6;">[R2-GigabitEthernet0/0/0]ip address 200.1.1.2 24</span></span>
<span class="line"><span style="color:#F0F3F6;">[R2-GigabitEthernet0/0/0]quit</span></span>
<span class="line"><span style="color:#F0F3F6;">[R2]interface GigabitEthernet 0/0/1</span></span>
<span class="line"><span style="color:#F0F3F6;">[R2-GigabitEthernet0/0/1]ip address 200.2.2.1 24</span></span></code></pre></div><p>完成配置后，可在PC1上去<code>ping</code> PC2 的地址，这样一来将在R1上触发IPsec VPN的感兴趣流量，R1-R3 之间就会开始进行IKE的协商。协商成功的标志是，在R1及R3上生成安全关联SA：</p><div class="language-shell" data-highlighter="shiki" data-ext="shell" data-title="shell" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span style="color:#F0F3F6;">[R1]display ike sa</span></span>
<span class="line"><span style="color:#FFB757;">    Conn-ID</span><span style="color:#ADDCFF;">  Peer</span><span style="color:#ADDCFF;">            VPN</span><span style="color:#ADDCFF;">   Flag</span><span style="color:#F0F3F6;">(</span><span style="color:#FFB757;">s</span><span style="color:#F0F3F6;">)                </span><span style="color:#ADDCFF;">Phase</span><span style="color:#F0F3F6;">  </span></span>
<span class="line"><span style="color:#FFB757;">  ---------------------------------------------------------------</span></span>
<span class="line"><span style="color:#FFB757;">       53</span><span style="color:#91CBFF;">    200.2.2.2</span><span style="color:#91CBFF;">       0</span><span style="color:#ADDCFF;">     RD</span><span style="color:#FF9492;">|</span><span style="color:#FFB757;">ST</span><span style="color:#91CBFF;">                  2</span><span style="color:#F0F3F6;">     </span></span>
<span class="line"><span style="color:#FFB757;">       52</span><span style="color:#91CBFF;">    200.2.2.2</span><span style="color:#91CBFF;">       0</span><span style="color:#ADDCFF;">     RD</span><span style="color:#FF9492;">|</span><span style="color:#FFB757;">ST</span><span style="color:#91CBFF;">                  1</span><span style="color:#F0F3F6;">     </span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFB757;">  Flag</span><span style="color:#ADDCFF;"> Description:</span></span>
<span class="line"><span style="color:#FFB757;">  RD--READY</span><span style="color:#ADDCFF;">   ST--STAYALIVE</span><span style="color:#ADDCFF;">   RL--REPLACED</span><span style="color:#ADDCFF;">   FD--FADING</span><span style="color:#ADDCFF;">   TO--TIMEOUT</span></span>
<span class="line"><span style="color:#FFB757;">  HRT--HEARTBEAT</span><span style="color:#ADDCFF;">   LKG--LAST</span><span style="color:#ADDCFF;"> KNOWN</span><span style="color:#ADDCFF;"> GOOD</span><span style="color:#ADDCFF;"> SEQ</span><span style="color:#ADDCFF;"> NO.</span><span style="color:#ADDCFF;">   BCK--BACKED</span><span style="color:#ADDCFF;"> UP</span></span>
<span class="line"><span style="color:#F0F3F6;">[R1]display ipsec sa</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ADDCFF;">===============================</span></span>
<span class="line"><span style="color:#FFB757;">Interface:</span><span style="color:#ADDCFF;"> GigabitEthernet0/0/0</span></span>
<span class="line"><span style="color:#FFB757;"> Path</span><span style="color:#ADDCFF;"> MTU:</span><span style="color:#91CBFF;"> 1500</span></span>
<span class="line"><span style="color:#ADDCFF;">===============================</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFB757;">  -----------------------------</span></span>
<span class="line"><span style="color:#FFB757;">  IPSec</span><span style="color:#ADDCFF;"> policy</span><span style="color:#ADDCFF;"> name:</span><span style="color:#ADDCFF;"> &quot;mypolicy&quot;</span></span>
<span class="line"><span style="color:#FFB757;">  Sequence</span><span style="color:#ADDCFF;"> number</span><span style="color:#ADDCFF;">  :</span><span style="color:#91CBFF;"> 10</span></span>
<span class="line"><span style="color:#FFB757;">  Acl</span><span style="color:#ADDCFF;"> Group</span><span style="color:#ADDCFF;">        :</span><span style="color:#91CBFF;"> 3000</span></span>
<span class="line"><span style="color:#FFB757;">  Acl</span><span style="color:#ADDCFF;"> rule</span><span style="color:#ADDCFF;">         :</span><span style="color:#91CBFF;"> 5</span></span>
<span class="line"><span style="color:#FFB757;">  Mode</span><span style="color:#ADDCFF;">             :</span><span style="color:#ADDCFF;"> ISAKMP</span></span>
<span class="line"><span style="color:#FFB757;">  -----------------------------</span></span>
<span class="line"><span style="color:#FFB757;">    Connection</span><span style="color:#ADDCFF;"> ID</span><span style="color:#ADDCFF;">     :</span><span style="color:#91CBFF;"> 53</span></span>
<span class="line"><span style="color:#FFB757;">    Encapsulation</span><span style="color:#ADDCFF;"> mode:</span><span style="color:#ADDCFF;"> Tunnel</span></span>
<span class="line"><span style="color:#FFB757;">    Tunnel</span><span style="color:#ADDCFF;"> local</span><span style="color:#ADDCFF;">      :</span><span style="color:#91CBFF;"> 200.1.1.1</span><span style="color:#BDC4CC;">  #IPsec Tunnel的本地地址</span></span>
<span class="line"><span style="color:#FFB757;">    Tunnel</span><span style="color:#ADDCFF;"> remote</span><span style="color:#ADDCFF;">     :</span><span style="color:#91CBFF;"> 200.2.2.2</span><span style="color:#BDC4CC;">  #IPSec Tunnel的远端地址</span></span>
<span class="line"><span style="color:#FFB757;">    Flow</span><span style="color:#ADDCFF;"> source</span><span style="color:#ADDCFF;">       :</span><span style="color:#ADDCFF;"> 192.168.1.0/255.255.255.0</span><span style="color:#ADDCFF;"> 0/0</span><span style="color:#BDC4CC;"> #感兴趣流量</span></span>
<span class="line"><span style="color:#FFB757;">    Flow</span><span style="color:#ADDCFF;"> destination</span><span style="color:#ADDCFF;">  :</span><span style="color:#ADDCFF;"> 192.168.2.0/255.255.255.0</span><span style="color:#ADDCFF;"> 0/0</span></span>
<span class="line"><span style="color:#FFB757;">    Qos</span><span style="color:#ADDCFF;"> pre-classify</span><span style="color:#ADDCFF;">  :</span><span style="color:#ADDCFF;"> Disable</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F0F3F6;">    [Outbound ESP SAs]  </span><span style="color:#BDC4CC;">#接口出站方向的ESP SAs</span></span>
<span class="line"><span style="color:#FFB757;">      SPI:</span><span style="color:#91CBFF;"> 3741715135</span><span style="color:#F0F3F6;"> (0xdf060abf)  </span><span style="color:#BDC4CC;">#出站SPI，对应R3上的入站SPI</span></span>
<span class="line"><span style="color:#FFB757;">      Proposal:</span><span style="color:#ADDCFF;"> ESP-ENCRYPT-3DES-192</span><span style="color:#ADDCFF;"> ESP-AUTH-SHA1</span></span>
<span class="line"><span style="color:#FFB757;">      SA</span><span style="color:#ADDCFF;"> remaining</span><span style="color:#ADDCFF;"> key</span><span style="color:#ADDCFF;"> duration</span><span style="color:#F0F3F6;"> (bytes/sec): 1887436800/3497</span></span>
<span class="line"><span style="color:#FFB757;">      Max</span><span style="color:#ADDCFF;"> sent</span><span style="color:#ADDCFF;"> sequence-number:</span><span style="color:#91CBFF;"> 0</span></span>
<span class="line"><span style="color:#FFB757;">      UDP</span><span style="color:#ADDCFF;"> encapsulation</span><span style="color:#ADDCFF;"> used</span><span style="color:#ADDCFF;"> for</span><span style="color:#ADDCFF;"> NAT</span><span style="color:#ADDCFF;"> traversal:</span><span style="color:#ADDCFF;"> N</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F0F3F6;">    [Inbound ESP SAs]   </span><span style="color:#BDC4CC;">#接口入站方向的ESP SAs</span></span>
<span class="line"><span style="color:#FFB757;">      SPI:</span><span style="color:#91CBFF;"> 2267390647</span><span style="color:#F0F3F6;"> (0x8725a2b7)  </span><span style="color:#BDC4CC;">#入站SPI，对应R3上的出站SPI</span></span>
<span class="line"><span style="color:#FFB757;">      Proposal:</span><span style="color:#ADDCFF;"> ESP-ENCRYPT-3DES-192</span><span style="color:#ADDCFF;"> ESP-AUTH-SHA1</span></span>
<span class="line"><span style="color:#FFB757;">      SA</span><span style="color:#ADDCFF;"> remaining</span><span style="color:#ADDCFF;"> key</span><span style="color:#ADDCFF;"> duration</span><span style="color:#F0F3F6;"> (bytes/sec): 1887436800/3497</span></span>
<span class="line"><span style="color:#FFB757;">      Max</span><span style="color:#ADDCFF;"> received</span><span style="color:#ADDCFF;"> sequence-number:</span><span style="color:#91CBFF;"> 0</span></span>
<span class="line"><span style="color:#FFB757;">      Anti-replay</span><span style="color:#ADDCFF;"> window</span><span style="color:#ADDCFF;"> size:</span><span style="color:#91CBFF;"> 32</span></span>
<span class="line"><span style="color:#FFB757;">      UDP</span><span style="color:#ADDCFF;"> encapsulation</span><span style="color:#ADDCFF;"> used</span><span style="color:#ADDCFF;"> for</span><span style="color:#ADDCFF;"> NAT</span><span style="color:#ADDCFF;"> traversal:</span><span style="color:#ADDCFF;"> N</span></span></code></pre></div><div class="language-shell" data-highlighter="shiki" data-ext="shell" data-title="shell" style="background-color:#0a0c10;color:#f0f3f6;"><pre class="shiki github-dark-high-contrast vp-code"><code><span class="line"><span style="color:#F0F3F6;">[R3]display ike sa</span></span>
<span class="line"><span style="color:#FFB757;">    Conn-ID</span><span style="color:#ADDCFF;">  Peer</span><span style="color:#ADDCFF;">            VPN</span><span style="color:#ADDCFF;">   Flag</span><span style="color:#F0F3F6;">(</span><span style="color:#FFB757;">s</span><span style="color:#F0F3F6;">)                </span><span style="color:#ADDCFF;">Phase</span><span style="color:#F0F3F6;">  </span></span>
<span class="line"><span style="color:#FFB757;">  ---------------------------------------------------------------</span></span>
<span class="line"><span style="color:#FFB757;">       13</span><span style="color:#91CBFF;">    200.1.1.1</span><span style="color:#91CBFF;">       0</span><span style="color:#ADDCFF;">     RD</span><span style="color:#91CBFF;">                     2</span><span style="color:#F0F3F6;">     </span></span>
<span class="line"><span style="color:#FFB757;">       12</span><span style="color:#91CBFF;">    200.1.1.1</span><span style="color:#91CBFF;">       0</span><span style="color:#ADDCFF;">     RD</span><span style="color:#91CBFF;">                     1</span><span style="color:#F0F3F6;">     </span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFB757;">  Flag</span><span style="color:#ADDCFF;"> Description:</span></span>
<span class="line"><span style="color:#FFB757;">  RD--READY</span><span style="color:#ADDCFF;">   ST--STAYALIVE</span><span style="color:#ADDCFF;">   RL--REPLACED</span><span style="color:#ADDCFF;">   FD--FADING</span><span style="color:#ADDCFF;">   TO--TIMEOUT</span></span>
<span class="line"><span style="color:#FFB757;">  HRT--HEARTBEAT</span><span style="color:#ADDCFF;">   LKG--LAST</span><span style="color:#ADDCFF;"> KNOWN</span><span style="color:#ADDCFF;"> GOOD</span><span style="color:#ADDCFF;"> SEQ</span><span style="color:#ADDCFF;"> NO.</span><span style="color:#ADDCFF;">   BCK--BACKED</span><span style="color:#ADDCFF;"> UP</span></span>
<span class="line"><span style="color:#F0F3F6;">[R3]display ipsec sa</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ADDCFF;">===============================</span></span>
<span class="line"><span style="color:#FFB757;">Interface:</span><span style="color:#ADDCFF;"> GigabitEthernet0/0/0</span></span>
<span class="line"><span style="color:#FFB757;"> Path</span><span style="color:#ADDCFF;"> MTU:</span><span style="color:#91CBFF;"> 1500</span></span>
<span class="line"><span style="color:#ADDCFF;">===============================</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFB757;">  -----------------------------</span></span>
<span class="line"><span style="color:#FFB757;">  IPSec</span><span style="color:#ADDCFF;"> policy</span><span style="color:#ADDCFF;"> name:</span><span style="color:#ADDCFF;"> &quot;mypolicy&quot;</span></span>
<span class="line"><span style="color:#FFB757;">  Sequence</span><span style="color:#ADDCFF;"> number</span><span style="color:#ADDCFF;">  :</span><span style="color:#91CBFF;"> 10</span></span>
<span class="line"><span style="color:#FFB757;">  Acl</span><span style="color:#ADDCFF;"> Group</span><span style="color:#ADDCFF;">        :</span><span style="color:#91CBFF;"> 3000</span></span>
<span class="line"><span style="color:#FFB757;">  Acl</span><span style="color:#ADDCFF;"> rule</span><span style="color:#ADDCFF;">         :</span><span style="color:#91CBFF;"> 5</span></span>
<span class="line"><span style="color:#FFB757;">  Mode</span><span style="color:#ADDCFF;">             :</span><span style="color:#ADDCFF;"> ISAKMP</span></span>
<span class="line"><span style="color:#FFB757;">  -----------------------------</span></span>
<span class="line"><span style="color:#FFB757;">    Connection</span><span style="color:#ADDCFF;"> ID</span><span style="color:#ADDCFF;">     :</span><span style="color:#91CBFF;"> 13</span></span>
<span class="line"><span style="color:#FFB757;">    Encapsulation</span><span style="color:#ADDCFF;"> mode:</span><span style="color:#ADDCFF;"> Tunnel</span></span>
<span class="line"><span style="color:#FFB757;">    Tunnel</span><span style="color:#ADDCFF;"> local</span><span style="color:#ADDCFF;">      :</span><span style="color:#91CBFF;"> 200.2.2.2</span></span>
<span class="line"><span style="color:#FFB757;">    Tunnel</span><span style="color:#ADDCFF;"> remote</span><span style="color:#ADDCFF;">     :</span><span style="color:#91CBFF;"> 200.1.1.1</span></span>
<span class="line"><span style="color:#FFB757;">    Flow</span><span style="color:#ADDCFF;"> source</span><span style="color:#ADDCFF;">       :</span><span style="color:#ADDCFF;"> 192.168.2.0/255.255.255.0</span><span style="color:#ADDCFF;"> 0/0</span></span>
<span class="line"><span style="color:#FFB757;">    Flow</span><span style="color:#ADDCFF;"> destination</span><span style="color:#ADDCFF;">  :</span><span style="color:#ADDCFF;"> 192.168.1.0/255.255.255.0</span><span style="color:#ADDCFF;"> 0/0</span></span>
<span class="line"><span style="color:#FFB757;">    Qos</span><span style="color:#ADDCFF;"> pre-classify</span><span style="color:#ADDCFF;">  :</span><span style="color:#ADDCFF;"> Disable</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F0F3F6;">    [Outbound ESP SAs]  </span><span style="color:#BDC4CC;">#接口出站方向的ESP SAs</span></span>
<span class="line"><span style="color:#FFB757;">      SPI:</span><span style="color:#91CBFF;"> 2267390647</span><span style="color:#F0F3F6;"> (0x8725a2b7)  </span><span style="color:#BDC4CC;">#出站SPI，对应R1上的入站SPI</span></span>
<span class="line"><span style="color:#FFB757;">      Proposal:</span><span style="color:#ADDCFF;"> ESP-ENCRYPT-3DES-192</span><span style="color:#ADDCFF;"> ESP-AUTH-SHA1</span></span>
<span class="line"><span style="color:#FFB757;">      SA</span><span style="color:#ADDCFF;"> remaining</span><span style="color:#ADDCFF;"> key</span><span style="color:#ADDCFF;"> duration</span><span style="color:#F0F3F6;"> (bytes/sec): 1887237120/3067</span></span>
<span class="line"><span style="color:#FFB757;">      Max</span><span style="color:#ADDCFF;"> sent</span><span style="color:#ADDCFF;"> sequence-number:</span><span style="color:#91CBFF;"> 13</span></span>
<span class="line"><span style="color:#FFB757;">      UDP</span><span style="color:#ADDCFF;"> encapsulation</span><span style="color:#ADDCFF;"> used</span><span style="color:#ADDCFF;"> for</span><span style="color:#ADDCFF;"> NAT</span><span style="color:#ADDCFF;"> traversal:</span><span style="color:#ADDCFF;"> N</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F0F3F6;">    [Inbound ESP SAs]   </span><span style="color:#BDC4CC;">#接口人站方向的ESP SAs</span></span>
<span class="line"><span style="color:#FFB757;">      SPI:</span><span style="color:#91CBFF;"> 3741715135</span><span style="color:#F0F3F6;"> (0xdf060abf)  </span><span style="color:#BDC4CC;">#入站SPI，对应R1上的出站SPI</span></span>
<span class="line"><span style="color:#FFB757;">      Proposal:</span><span style="color:#ADDCFF;"> ESP-ENCRYPT-3DES-192</span><span style="color:#ADDCFF;"> ESP-AUTH-SHA1</span></span>
<span class="line"><span style="color:#FFB757;">      SA</span><span style="color:#ADDCFF;"> remaining</span><span style="color:#ADDCFF;"> key</span><span style="color:#ADDCFF;"> duration</span><span style="color:#F0F3F6;"> (bytes/sec): 1887435900/3067</span></span>
<span class="line"><span style="color:#FFB757;">      Max</span><span style="color:#ADDCFF;"> received</span><span style="color:#ADDCFF;"> sequence-number:</span><span style="color:#91CBFF;"> 15</span></span>
<span class="line"><span style="color:#FFB757;">      Anti-replay</span><span style="color:#ADDCFF;"> window</span><span style="color:#ADDCFF;"> size:</span><span style="color:#91CBFF;"> 32</span></span>
<span class="line"><span style="color:#FFB757;">      UDP</span><span style="color:#ADDCFF;"> encapsulation</span><span style="color:#ADDCFF;"> used</span><span style="color:#ADDCFF;"> for</span><span style="color:#ADDCFF;"> NAT</span><span style="color:#ADDCFF;"> traversal:</span><span style="color:#ADDCFF;"> N</span></span></code></pre></div>`,108)]))}const b=l(S,[["render",E],["__file","VPN详解.html.vue"]]),N=JSON.parse('{"path":"/network/VPN%E8%AF%A6%E8%A7%A3.html","title":"VPN详解","lang":"zh-CN","frontmatter":{"title":"VPN详解","date":"2025-04-15T00:00:00.000Z","tags":"network","categories":"计算机网络","order":22,"description":"VPN 技术还是企业比较常用的通信技术，如果一个企业的分公司和总部的互访，或者出差员工需要访问总部的网络，都会使用 VPN 技术。 什么是VPN VPN技术出现背景 在没有 VPN 之前，企业的总部和分部之间的互通都是采用运营商的 Internet 进行通信，那么 Internet 中往往是不安全的，通信的内容可能被窃取、修改等，从而造成安全事件。 那...","head":[["meta",{"property":"og:url","content":"https://0oWSQo0.github.io/wsq-blog/network/VPN%E8%AF%A6%E8%A7%A3.html"}],["meta",{"property":"og:title","content":"VPN详解"}],["meta",{"property":"og:description","content":"VPN 技术还是企业比较常用的通信技术，如果一个企业的分公司和总部的互访，或者出差员工需要访问总部的网络，都会使用 VPN 技术。 什么是VPN VPN技术出现背景 在没有 VPN 之前，企业的总部和分部之间的互通都是采用运营商的 Internet 进行通信，那么 Internet 中往往是不安全的，通信的内容可能被窃取、修改等，从而造成安全事件。 那..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-05-14T10:35:45.000Z"}],["meta",{"property":"article:published_time","content":"2025-04-15T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-05-14T10:35:45.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"VPN详解\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2025-04-15T00:00:00.000Z\\",\\"dateModified\\":\\"2025-05-14T10:35:45.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"WSQ\\",\\"url\\":\\"https://0oWSQo0.github.com\\"}]}"]]},"headers":[{"level":2,"title":"什么是VPN","slug":"什么是vpn","link":"#什么是vpn","children":[{"level":3,"title":"VPN技术出现背景","slug":"vpn技术出现背景","link":"#vpn技术出现背景","children":[]},{"level":3,"title":"什么是 VPN","slug":"什么是-vpn","link":"#什么是-vpn","children":[]}]},{"level":2,"title":"VPN技术优势","slug":"vpn技术优势","link":"#vpn技术优势","children":[]},{"level":2,"title":"内联网和外联网","slug":"内联网和外联网","link":"#内联网和外联网","children":[]},{"level":2,"title":"VPN分类","slug":"vpn分类","link":"#vpn分类","children":[{"level":3,"title":"根据 VPN 建设单位不同进行划分","slug":"根据-vpn-建设单位不同进行划分","link":"#根据-vpn-建设单位不同进行划分","children":[]},{"level":3,"title":"根据组网方式进行划分","slug":"根据组网方式进行划分","link":"#根据组网方式进行划分","children":[]},{"level":3,"title":"根据工作网络层次进行划分","slug":"根据工作网络层次进行划分","link":"#根据工作网络层次进行划分","children":[]}]},{"level":2,"title":"VPN关键技术","slug":"vpn关键技术","link":"#vpn关键技术","children":[{"level":3,"title":"隧道技术","slug":"隧道技术","link":"#隧道技术","children":[]},{"level":3,"title":"身份认证、数据加密、数据验证","slug":"身份认证、数据加密、数据验证","link":"#身份认证、数据加密、数据验证","children":[]}]},{"level":2,"title":"GRE","slug":"gre","link":"#gre","children":[{"level":3,"title":"GRE的配置及实现","slug":"gre的配置及实现","link":"#gre的配置及实现","children":[]}]},{"level":2,"title":"IPSecVPN","slug":"ipsecvpn","link":"#ipsecvpn","children":[{"level":3,"title":"IPSec协议框架","slug":"ipsec协议框架","link":"#ipsec协议框架","children":[]},{"level":3,"title":"IKE的两个阶段","slug":"ike的两个阶段","link":"#ike的两个阶段","children":[]},{"level":3,"title":"路由器上的LAN-to-LAN IPSec VPN（IKE协商）","slug":"路由器上的lan-to-lan-ipsec-vpn-ike协商","link":"#路由器上的lan-to-lan-ipsec-vpn-ike协商","children":[]}]}],"git":{"createdTime":1730426129000,"updatedTime":1747218945000,"contributors":[{"name":"WSQ-LK","email":"592786982@qq.com","commits":1}]},"readingTime":{"minutes":21.61,"words":6483},"filePathRelative":"network/VPN详解.md","localizedDate":"2025年4月15日","autoDesc":true}');export{b as comp,N as data};
